<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="English Sentences Journey - An interactive game to learn English sentences from A1 to B2 levels.">
    <title>English Sentences Journey | M.H.</title>
    <style>
        /*
         * UI Enhancement: Ultimate Aesthetic - Modern, Deep, and Consistent Design
         */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Poppins:wght@400;600;700;900&display=swap');

        :root {
            --font-ar: 'Cairo', sans-serif;
            --font-en: 'Poppins', sans-serif;
            
            /* Light Theme - Soft, Clean, Elegant */
            --bg-light: #f0f4f8;
            --surface-light: #ffffff;
            --text-primary-light: #102a43;
            --text-secondary-light: #627d98;
            --accent-light: #4c7cff; /* Vibrant Blue */
            --border-light: #dfe8f2;
            --shadow-light: 0 8px 25px rgba(10, 30, 50, 0.12); /* Deep, soft shadow */
            --inner-shadow-light: inset 0 2px 4px rgba(0, 0, 0, 0.05);

            /* Dark Theme - Obsidian, Modern, High Contrast */
            --bg-dark: #121822;
            --surface-dark: #1c2635;
            --text-primary-dark: #eef5ff;
            --text-secondary-dark: #a9b5c3;
            --accent-dark: #6e9dff; /* Lighter vibrant blue for dark mode */
            --border-dark: #2a3545;
            --shadow-dark: 0 8px 25px rgba(0, 0, 0, 0.5);
            --inner-shadow-dark: inset 0 2px 4px rgba(0, 0, 0, 0.35);

            /* Level Colors */
            --a1-color: #4CAF50; /* Green */
            --a2-color: #2196F3; /* Blue */
            --b1-color: #FF9800; /* Orange */
            --b2-color: #9C27B0; /* Purple */

            /* Feedback Colors */
            --success-color: #38c172;
            --error-color: #e3342f;
            --timer-color: #ff5722; /* Deep Orange for Timer */
            
            /* Apply theme */
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --accent: var(--accent-light);
            --border-color: var(--border-light);
            --box-shadow: var(--shadow-light);
            --inner-box-shadow: var(--inner-box-shadow);
        }
        
        body[data-theme="dark"] {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --accent: var(--accent-dark);
            --border-color: var(--border-dark);
            --box-shadow: var(--shadow-dark);
            --inner-box-shadow: var(--inner-box-shadow);
        }
        
        /* Global & Utility */
        body.correct-flash { animation: flashGreen 0.3s ease-in-out; }
        body.incorrect-flash { animation: flashRed 0.3s ease-in-out; }
        @keyframes flashGreen { from { background-color: var(--success-color); } to { background-color: var(--bg); } }
        @keyframes flashRed { from { background-color: var(--error-color); } to { background-color: var(--bg); } }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-ar), var(--font-en), sans-serif;
            background-color: var(--bg); color: var(--text-primary);
            line-height: 1.6; transition: background-color 0.4s, color 0.4s;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        #app { max-width: 800px; margin: 0 auto; padding: clamp(1rem, 5vw, 2.5rem); min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .screen { animation: fadeIn 0.6s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* New Logo Style */
        #main-logo {
            font-family: var(--font-en); font-size: 2.8rem; font-weight: 900; 
            color: var(--accent); transition: color 0.3s;
            line-height: 1;
        }
        #main-logo span {
            color: var(--text-primary);
        }

        /* Professional Buttons */
        .btn {
            display: inline-flex; justify-content: center; align-items: center; gap: 0.5rem;
            padding: 1.1rem 2.5rem; font-size: 1.05rem; font-weight: 700;
            border-radius: 15px; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-color: var(--accent); color: white; text-decoration: none;
            box-shadow: 0 4px 15px rgba(76, 124, 255, 0.4);
        }
        .btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(76, 124, 255, 0.6); 
            background-color: color-mix(in srgb, var(--accent) 90%, black);
        }
        .btn-secondary { 
            background-color: var(--text-secondary); color: var(--bg); 
            box-shadow: 0 4px 10px rgba(98, 125, 152, 0.5);
        }
        .btn-secondary:hover { 
            background-color: color-mix(in srgb, var(--text-secondary) 90%, black);
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(98, 125, 152, 0.7); 
        }
        .btn-icon { 
            background: var(--surface); border: 1px solid var(--border-color); 
            font-size: 1.6rem; cursor: pointer; color: var(--text-secondary); padding: 0.8rem; 
            border-radius: 15px; transition: all 0.3s; box-shadow: var(--shadow-light);
        }
        .btn-icon:hover { 
            color: var(--accent); 
            background-color: var(--bg); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }

        /* Main Menu Screen - Streamlined and Smooth */
        #main-menu-screen header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 2rem; 
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        #main-menu-controls { display: flex; gap: 0.5rem; }
        
        .level-card { 
            background-color: var(--surface); border-radius: 25px; padding: 1.5rem 2rem; 
            border: 1px solid var(--border-color); box-shadow: var(--box-shadow); 
            transition: all 0.4s; 
            margin-bottom: 1.5rem; /* Reduced gap */
        }
        .level-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(10, 30, 50, 0.15); }
        .level-card.locked { opacity: 0.5; pointer-events: none; }
        
        .level-card-header { 
            display: flex; align-items: center; justify-content: space-between; 
            margin-bottom: 1rem; 
            cursor: pointer; 
        }
        .level-info { display: flex; align-items: center; gap: 1rem; }
        .level-icon { font-size: 2.5rem; }
        .level-name { font-size: 1.5rem; font-weight: 900; color: var(--text-primary); }
        
        /* Sub-Level Grid */
        .sub-level-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 10px; 
            padding-top: 0; /* Changed for animation */
            border-top: 1px dashed var(--border-color);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s;
        }
        .level-card.expanded .sub-level-container {
            max-height: 500px; /* Sufficiently large value */
            padding-top: 1rem;
        }

        .sub-level {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; height: 60px; border-radius: 12px; 
            border: 2px solid var(--border-color);
            font-weight: 700; font-size: 1.2rem; cursor: pointer; position: relative;
            background-color: var(--bg); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .sub-level:hover { 
            transform: scale(1.05); 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); 
            border-color: var(--accent); 
            color: var(--accent);
        }
        .sub-level.completed { border-color: var(--success-color); color: var(--success-color); }
        .sub-level.locked { background-color: var(--border-color); color: var(--text-secondary); opacity: 0.7; }

        /* Game Screen Elements */
        #game-screen header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        
        #progress-timer-container {
            display: flex; align-items: center; flex-grow: 1; margin: 0 1rem;
        }

        #session-progress-bar { 
            flex-grow: 1; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;
        }
        #session-progress-fill { height: 100%; width: 0; background: var(--accent); transition: width 0.3s; }
        
        #timer-display {
            font-weight: 900; font-size: 1.2rem; margin-left: 1rem; color: var(--timer-color);
            min-width: 30px; /* Ensure space for two digits */
            text-align: center;
        }

        #score-display, #streak-display { font-weight: 700; font-size: 1.2rem; }
        
        .sentence-box { 
            background: var(--surface); padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; 
            box-shadow: var(--box-shadow); text-align: center;
        }
        #sentence-en-box { 
            border: 2px solid var(--accent); 
            font-family: var(--font-en); font-size: 1.3rem; font-weight: 600;
        }
        #sentence-ar-box { 
            color: var(--text-secondary); 
            font-family: var(--font-ar); font-size: 1.1rem;
        }
        
        #typing-input {
            width: 100%; padding: 1rem; border: 2px solid var(--border-color); 
            border-radius: 12px; font-size: 1.2rem; font-family: var(--font-en);
            background: var(--bg); color: var(--text-primary);
            transition: border-color 0.3s, box-shadow 0.3s;
            text-align: left; /* Default left for LTR input */
        }
        #typing-input:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(76, 124, 255, 0.3);
        }
        
        #mcq-options, #word-bank, #word-selection-bank {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2rem;
        }
        #mcq-options .btn { width: 100%; padding: 1rem 1.5rem; font-size: 1rem; }
        
        .word-chip, .word-to-select {
            padding: 0.7rem 1rem; border-radius: 8px; background: var(--surface);
            border: 1px solid var(--border-color); cursor: pointer; text-align: center;
            font-family: var(--font-en); font-weight: 600; transition: all 0.2s;
        }
        .word-to-select:hover { background-color: var(--bg); border-color: var(--accent); color: var(--accent); }
        
        #ordered-sentence-area {
            min-height: 60px; border: 2px dashed var(--border-color); border-radius: 12px;
            padding: 10px; margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 8px;
            align-items: center;
            background: var(--surface);
        }
        .selected-word {
            background-color: var(--accent); color: white; padding: 5px 10px; border-radius: 6px;
            cursor: pointer; font-family: var(--font-en); font-weight: 600; transition: background-color 0.2s;
        }
        
        /* Game Controls */
        #game-controls {
            display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;
            flex-wrap: wrap; gap: 1rem;
        }
        #game-controls-left {
            display: flex; gap: 0.5rem;
        }
        /* Hidden hint button since it's removed */
        #hint-btn { display: none !important; }

        /* Modal Style */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7); z-index: 999; 
            transition: opacity 0.3s;
        }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1000; background: var(--surface);
            padding: 3rem; 
            border-radius: 30px; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.35);
            max-width: 90%; width: 500px;
        }
        
        #mode-selection-modal .modal-title { color: var(--accent); font-size: 2rem; font-weight: 900; margin-bottom: 2rem; }
        #mode-selection-modal .modal-body { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; 
            max-height: 70vh; overflow-y: auto;
        }
        #mode-selection-modal .btn {
            padding: 1rem 1.5rem;
            text-align: right;
            justify-content: flex-start;
            background-color: var(--surface);
            color: var(--text-primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        #mode-selection-modal .btn:hover {
            border-color: var(--accent);
            transform: scale(1.03);
            background-color: var(--bg);
        }

        /* Generic Screen Styles for Favorites, Settings, Stats */
        .setting-row, .stat-item, .achievement-item, .favorite-sentence-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; margin-bottom: 1rem;
            background: var(--surface); border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            position: relative; /* Needed for absolute positioning of the remove button */
        }
        .favorite-sentence-item {
            flex-direction: column; align-items: flex-start;
            padding-right: 40px; /* Space for the remove button */
        }
        .favorite-sentence-item p { margin-bottom: 0.5rem; }
        .favorite-sentence-item .en { font-family: var(--font-en); font-weight: 600; font-size: 1.1rem; color: var(--text-primary); }
        .favorite-sentence-item .ar { font-family: var(--font-ar); color: var(--text-secondary); }
        /* Style for the Thematic button in mode selection (to use same style but centered) */
        #mode-selection-modal .theme-btn {
            justify-content: center;
            text-align: center;
        }
        /* Added Pronunciation Mode button styling */
        #pronunciation-container .btn-icon {
            font-size: 1.2rem;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            margin: 0 0.5rem;
        }
        #record-btn {
            background-color: var(--error-color);
            color: white;
        }
        #record-btn.btn-secondary {
            background-color: var(--success-color);
        }
    </style>
</head>
<body data-theme="light">

    <div id="app">
        <div id="splash-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh;">
            <h1 id="main-logo" style="margin-bottom: 1rem;">M<span>-H</span></h1>
            <h2 id="splash-title" style="margin-bottom: 2rem;">English Sentences Journey</h2>
            <div id="loading-bar" style="width: 80%; background: var(--border-color); border-radius: 5px; overflow: hidden;"><div id="loading-progress" style="height: 10px; width: 0; background-color: var(--accent); transition: width 0.3s;"></div></div>
            <p id="loading-status" style="margin-top: 15px; color: var(--text-secondary);"></p>
        </div>
        
        <div id="main-menu-screen" class="screen hidden">
            <header>
                <h1 id="main-logo">M<span>-H</span></h1>
                <div id="main-menu-controls">
                    <button id="achievements-btn" class="btn-icon" title="Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª">ğŸ†</button>
                    <button id="stats-btn" class="btn-icon" title="Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">ğŸ“Š</button>
                    <button id="settings-btn" class="btn-icon" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
                </div>
            </header>
            <main>
                <h2 style="margin-bottom: 1.5rem; font-weight: 700;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h2>
                <div id="level-container"></div>
            </main>
        </div>
        
        <div id="game-screen" class="screen hidden">
            <header>
                <button id="back-to-menu-btn" class="btn-icon" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©">â†©ï¸</button>
                <div id="progress-timer-container">
                    <div id="session-progress-bar"><div id="session-progress-fill"></div></div>
                    <div id="timer-display" class="hidden">30</div>
                </div>
                <div id="score-display">0</div>
                <div id="streak-display">ğŸ”¥0</div>
            </header>
            
            <main>
                <div id="sentence-container">
                    <div id="sentence-en-box" class="sentence-box"><p id="sentence-en"></p></div>
                    <div id="sentence-ar-box" class="sentence-box"><p id="sentence-ar"></p></div>
                </div>
                
                <div id="game-mode-container">
                    <div id="typing-container" class="hidden"><input type="text" id="typing-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©..."></div>
                    <div id="dictation-container" class="hidden" style="text-align: center; margin-bottom: 1rem;">
                        <button id="dictation-play-btn" class="btn-icon" style="font-size: 2.5rem; padding: 1.2rem; border-radius: 50%;">ğŸ¤</button>
                    </div>
                    <div id="mcq-container" class="hidden"><div id="mcq-options"></div></div>
                    <div id="listen-container" class="hidden" style="text-align: center; margin-bottom: 1rem;"><button id="play-sound-btn" class="btn-icon" style="font-size: 2.5rem; padding: 1.2rem; border-radius: 50%;">ğŸ”Š</button></div>
                    <div id="fill-blank-container" class="hidden"><div id="word-blanks" style="text-align: center; font-size: 1.3rem; margin-bottom: 2rem;"></div><div id="word-bank"></div></div>
                    <div id="order-words-container" class="hidden">
                        <div id="ordered-sentence-area"></div>
                        <div id="word-selection-bank"></div>
                    </div>
                    <div id="pronunciation-container" class="hidden" style="text-align: center; margin-top: 1rem;">
                        <button id="record-btn" class="btn-icon" title="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„">ğŸ¤</button>
                        <button id="play-user-btn" class="btn-icon" disabled title="ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">ğŸ‘‚ ØµÙˆØªÙŠ</button>
                        <button id="play-model-btn" class="btn-icon" title="ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬">ğŸ”Š Ù†Ù…ÙˆØ°Ø¬</button>
                    </div>
                </div>
                
                <div id="game-controls">
                    <div id="game-controls-left">
                        <button id="fav-btn" class="btn-icon">ğŸ¤</button>
                        <button id="replay-sound-btn" class="btn-icon" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚">ğŸ”Š</button>
                    </div>
                    <button id="check-btn" class="btn">ØªØ­Ù‚Ù‚</button>
                    <button id="next-btn" class="btn hidden">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                </div>
            </main>
        </div>
        
        <div id="generic-screen" class="screen hidden"><header><button id="generic-back-btn" class="btn-icon">â†©ï¸</button><h2 id="generic-title" style="flex-grow: 1;"></h2></header><main id="generic-content"></main></div>

        <div id="summary-modal" class="hidden"><div class="modal-overlay"></div><div class="modal"><div class="modal-header"><h2 class="modal-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø©</h2></div><div class="modal-body"><p id="summary-score"></p><p id="summary-accuracy"></p><div id="review-mistakes-area"></div></div><div class="modal-footer"><button id="review-mistakes-btn" class="btn btn-secondary">Ø±Ø§Ø¬Ø¹ Ø£Ø®Ø·Ø§Ø¦ÙŠ</button><button id="summary-close-btn" class="btn">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>
        
        <div id="mode-selection-modal" class="hidden">
            <div class="modal-overlay"></div>
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h2></div>
                <div class="modal-body" id="mode-selection-buttons">
                    </div>
                <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <button class="btn btn-secondary" id="common-mistakes-challenge-btn" style="flex-grow: 1;">ğŸ” ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
                    <button class="btn btn-secondary" id="thematic-challenge-btn" style="flex-grow: 1;">ğŸŒ ØªØ­Ø¯ÙŠ Ù…ÙˆØ¶ÙˆØ¹ÙŠ</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
    <audio id="success-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-success-505.mp3" preload="auto"></audio>
    <audio id="fail-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-223.mp3" preload="auto"></audio>
    <audio id="click-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-interface-click-1126.mp3" preload="auto"></audio>
    <audio id="tts-fallback-audio" preload="auto"></audio> 
    <audio id="user-playback-audio" preload="auto"></audio> 

    <script>
    (function() {
        "use strict";

        // --- 1. STATE & CONSTANTS ---
        const SUB_LEVEL_SIZE = 20;
        const UNLOCK_PERCENTAGE = 75;
        const TIMER_DURATION_SEC = 30;
        const TYPING_CHALLENGE_DURATION_SEC = 30; // UPDATED to 30 seconds
        
        const LEVELS_FILES = [
            { level: 'A1', file: 'sentences1.json' },
            { level: 'A2', file: 'sentences2.json' },
            { level: 'B1', file: 'sentences3.json' },
            { level: 'B2', file: 'sentences4.json' }
        ];

        // NEW LS version
        const LS_KEYS = { USER_DATA: 'esj_userData_v18', SETTINGS: 'esj_settings_v18' }; 
        
        const app = {
            sentences: {}, userData: {}, settings: {},
            currentSession: null, pendingSession: {},
            isInitialized: false, ttsVoices: [],
            orderWordsUserSequence: [], 
            currentStreak: 0, 
            timerInterval: null, 
            timerSeconds: 0, 
            
            // NEW: Pronunciation recording state
            mediaRecorder: null,
            audioChunks: [],
            userAudioURL: null,
        };
        const DOMElements = {
            splashScreen: document.getElementById('splash-screen'),
            mainMenuScreen: document.getElementById('main-menu-screen'),
            gameScreen: document.getElementById('game-screen'),
            genericScreen: {
                screen: document.getElementById('generic-screen'),
                title: document.getElementById('generic-title'),
                content: document.getElementById('generic-content'),
                backBtn: document.getElementById('generic-back-btn'),
            },
            levelContainer: document.getElementById('level-container'),
            toastContainer: document.getElementById('toast-container'),
            game: {
                sessionProgressBar: document.getElementById('session-progress-fill'),
                timerDisplay: document.getElementById('timer-display'), 
                scoreDisplay: document.getElementById('score-display'),
                streakDisplay: document.getElementById('streak-display'),
                sentenceEn: document.getElementById('sentence-en'),
                sentenceAr: document.getElementById('sentence-ar'),
                typingInput: document.getElementById('typing-input'),
                mcqOptions: document.getElementById('mcq-options'),
                wordBlanks: document.getElementById('word-blanks'),
                wordBank: document.getElementById('word-bank'),
                checkBtn: document.getElementById('check-btn'),
                nextBtn: document.getElementById('next-btn'),
                mcqContainer: document.getElementById('mcq-container'),
                typingContainer: document.getElementById('typing-container'),
                listenContainer: document.getElementById('listen-container'),
                playAudioBtn: document.getElementById('play-sound-btn'), 
                fillBlankContainer: document.getElementById('fill-blank-container'),
                orderWordsContainer: document.getElementById('order-words-container'),
                orderedSentenceArea: document.getElementById('ordered-sentence-area'),
                wordSelectionBank: document.getElementById('word-selection-bank'),
                dictationContainer: document.getElementById('dictation-container'),
                dictationPlayBtn: document.getElementById('dictation-play-btn'),
                sentenceEnBox: document.getElementById('sentence-en-box'),
                sentenceArBox: document.getElementById('sentence-ar-box'),
                favBtn: document.getElementById('fav-btn'),
                replaySoundBtn: document.getElementById('replay-sound-btn'),
                
                // NEW Pronunciation elements
                pronunciationContainer: document.getElementById('pronunciation-container'),
                recordBtn: document.getElementById('record-btn'),
                playUserBtn: document.getElementById('play-user-btn'),
                playModelBtn: document.getElementById('play-model-btn'),
            },
            modals: {
                summary: document.getElementById('summary-modal'),
                modeSelection: document.getElementById('mode-selection-modal'),
                modeSelectionButtons: document.getElementById('mode-selection-buttons'),
                summaryReviewArea: document.getElementById('review-mistakes-area'),
                reviewMistakesBtn: document.getElementById('review-mistakes-btn'),
                // NEW Challenge buttons
                commonMistakesBtn: document.getElementById('common-mistakes-challenge-btn'),
                thematicChallengeBtn: document.getElementById('thematic-challenge-btn'),
            },
            audio: {
                success: document.getElementById('success-sound'),
                fail: document.getElementById('fail-sound'),
                click: document.getElementById('click-sound'),
                ttsFallback: document.getElementById('tts-fallback-audio'),
                userPlayback: document.getElementById('user-playback-audio'), // NEW
            }
        };
        
        const ACHIEVEMENTS = {
            FIRST_CORRECT: { id: 'FIRST_CORRECT', name: 'Ø£ÙˆÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©', description: 'Ø£ÙˆÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©', icon: 'ğŸ¯' },
            A1_LEVEL_MASTER: { id: 'A1_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ A1', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ A1', icon: 'ğŸ“' },
            A2_LEVEL_MASTER: { id: 'A2_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ A2', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ A2', icon: 'ğŸŒŸ' },
            B1_LEVEL_MASTER: { id: 'B1_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ B1', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ B1', icon: 'ğŸ…' },
            B2_LEVEL_MASTER: { id: 'B2_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ B2', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ B2', icon: 'ğŸ†' },
        };
        
        // --- 2. DATA MANAGEMENT (Retained and Updated) ---
        function getDefaultUserData() { 
            return { 
                unlockedSubLevels: { 'A1': ['1'] }, 
                stats: { totalScore: 0, totalMistakes: 0, completedLevels: [] }, 
                longestStreak: 0, 
                achievements: {}, 
                favorites: [], 
                permanentMistakes: [], // NEW: To store mistakes for the review challenge
            }; 
        }
        function getDefaultSettings() { return { theme: 'light', soundEffects: true, ttsEnabled: true, ttsSpeed: 1.0, hapticsEnabled: true }; }
        function saveData() { localStorage.setItem(LS_KEYS.USER_DATA, JSON.stringify(app.userData)); }
        function saveSettings() { localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(app.settings)); }
        function loadData() {
            app.settings = { ...getDefaultSettings(), ...JSON.parse(localStorage.getItem(LS_KEYS.SETTINGS) || '{}') };
            app.userData = { ...getDefaultUserData(), ...JSON.parse(localStorage.getItem(LS_KEYS.USER_DATA) || '{}') };
        }

        // --- 3. CORE UTILITIES (TTS FIXED) ---
        function playSound(type) {
            if (!app.settings.soundEffects) return;
            const sound = DOMElements.audio[type];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.error("Sound playback failed:", e));
            }
        }
        
        function flashScreen(type) {
            document.body.classList.add(`${type}-flash`);
            setTimeout(() => { document.body.classList.remove(`${type}-flash`); }, 300);
        }

        // IMPROVED TTS (Text-to-Speech) function
        function speak(text) {
            if (!app.settings.ttsEnabled || !text) return;
            const useWebSpeech = 'speechSynthesis' in window;
            if (useWebSpeech) {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = app.settings.ttsSpeed;
                
                if (app.ttsVoices.length > 0) {
                     utterance.voice = app.ttsVoices.find(v => v.lang.startsWith('en')) || app.ttsVoices[0];
                }
                
                speechSynthesis.speak(utterance);
            } else {
                const encodedText = encodeURIComponent(text);
                const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=en&client=tw-ob`; 
                const audio = DOMElements.audio.ttsFallback;
                audio.pause();
                audio.currentTime = 0;
                audio.src = ttsUrl;
                audio.play().catch(e => console.error("Fallback TTS playback failed:", e));
            }
        }

        function vibrate(d=50) { if(app.settings.hapticsEnabled && 'vibrate' in navigator) navigator.vibrate(d); }
        function showToast(message, type = 'info', icon = 'â„¹ï¸') {
            const toast = document.createElement('div');
            // Basic toast styling for now (CSS could be more detailed)
            toast.style.cssText = `
                background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : 'var(--accent)'};
                color: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px;
                animation: slideIn 0.3s ease-out;
            `;
            if (!document.getElementById('toast-keyframes')) {
                const style = document.createElement('style');
                style.id = 'toast-keyframes';
                style.textContent = `@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
                document.head.appendChild(style);
            }
            
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        let currentScreen = 'splash-screen';
        function showScreen(screenId) {
            document.getElementById(currentScreen)?.classList.add('hidden');
            document.getElementById(screenId)?.classList.remove('hidden');
            currentScreen = screenId;
        }
        
        function shuffleArray(array) {
            const newArray = [...array]; 
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        function cleanString(str) {
            // Remove all punctuation (except space) and convert to lowercase for better comparison
            return str.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
        }
        
        function simplifyString(str) {
            // Used for looser comparison in typing mode
            return cleanString(str).replace(/\b(a|an|the|is|are|am|do|does|did|will|would|can|could)\b/g, '').replace(/\s+/g, ' ').trim();
        }

        // --- 4. UI RENDERING ---
        function renderMainMenu() {
            // Clear any running timer before rendering main menu
            clearTimer(); 

            const container = DOMElements.levelContainer;
            container.innerHTML = ''; 
            const mainLevels = Object.keys(app.sentences).filter(l => Object.keys(app.sentences[l] || {}).length > 0).sort();

            mainLevels.forEach(level => {
                if (!app.userData.unlockedSubLevels[level]) {
                    app.userData.unlockedSubLevels[level] = [];
                }
                
                const isLevelUnlocked = app.userData.unlockedSubLevels[level].includes('1'); 
                
                const levelCard = document.createElement('div');
                levelCard.className = `level-card ${isLevelUnlocked ? '' : 'locked'}`; 
                
                const levelIcon = {'A1':'ğŸŒ±','A2':'ğŸ”µ','B1':'ğŸŸ ','B2':'ğŸŸ£'}[level] || 'â­';
                const levelColor = `var(--${level.toLowerCase()}-color)`;
                
                levelCard.innerHTML = `
                    <div class="level-card-header" data-level="${level}">
                        <div class="level-info">
                            <div class="level-icon" style="color: ${levelColor}">${levelIcon}</div>
                            <div class="level-name">${level}</div>
                        </div>
                        <span class="expand-icon">â–¶ï¸</span>
                    </div>
                    <div class="sub-level-container"></div>
                `;
                
                const subLevelContainer = levelCard.querySelector('.sub-level-container');
                
                // Sort sub-levels numerically (since keys are strings)
                Object.keys(app.sentences[level]).sort((a,b)=>+a - +b).forEach(key => {
                    const subLevelEl = document.createElement('div');
                    subLevelEl.className = 'sub-level';
                    subLevelEl.textContent = key;
                    const levelKey = `${level}-${key}`;
                    
                    if (app.userData.unlockedSubLevels[level].includes(key)) {
                        subLevelEl.onclick = () => { playSound('click'); showModeSelectionModal(level, key); };
                        
                        if (app.userData.stats.completedLevels.includes(levelKey)) {
                            subLevelEl.classList.add('completed');
                        }

                    } else {
                        subLevelEl.classList.add('locked');
                        subLevelEl.onclick = () => { vibrate(50); showToast('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…Ù‚ÙÙ„. Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©!', 'error', 'ğŸ”’'); };
                    }
                    subLevelContainer.appendChild(subLevelEl);
                });

                const header = levelCard.querySelector('.level-card-header');
                const expandIcon = header.querySelector('.expand-icon');
                header.onclick = (e) => {
                    if (e.target.closest('.sub-level')) return; 
                    
                    levelCard.classList.toggle('expanded');
                    expandIcon.textContent = levelCard.classList.contains('expanded') ? 'â–¼' : 'â–¶ï¸';
                };
                
                container.appendChild(levelCard);
            });
            showScreen('main-menu-screen');
        }

        function renderModeSelectionButtons() {
            const buttonsHTML = `
                <button class="btn" data-mode="Learning">ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ù„Ù… (Ù‚Ø±Ø§Ø¡Ø©)</button>
                <button class="btn" data-mode="MCQ">ğŸ”  Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ (Ø§Ù„ØªØ±Ø¬Ù…Ø©)</button>
                <button class="btn" data-mode="ListenType">ğŸ§ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ (MCQ)</button>
                <button class="btn" data-mode="Typing">âŒ¨ï¸ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø§Ù„ØªØ±Ø¬Ù…Ø©)</button>
                <button class="btn" data-mode="Dictation">ğŸ¤ Ø¥Ù…Ù„Ø§Ø¡ (Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆÙƒØªØ§Ø¨Ø©)</button>
                <button class="btn" data-mode="OrderWords">ğŸ“ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
                <button class="btn" data-mode="FillBlank">âœï¸ Ø§Ù…Ù„Ø£ Ø§Ù„ÙØ±Ø§Øº</button>
                <button class="btn" data-mode="Pronunciation">ğŸ—£ï¸ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†Ø·Ù‚</button>
                <button class="btn" data-mode="TypingChallenge">â±ï¸ ØªØ­Ø¯ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© (${TYPING_CHALLENGE_DURATION_SEC} Ø«Ø§Ù†ÙŠØ©)</button> 
                <button class="btn btn-secondary" data-mode="Challenge">ğŸ² ØªØ­Ø¯ÙŠ Ù…ØªÙ†ÙˆØ¹</button>
            `;
            DOMElements.modals.modeSelectionButtons.innerHTML = buttonsHTML;
            DOMElements.modals.modeSelection.querySelector('.modal-header .modal-title').textContent = 'Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
            DOMElements.modals.modeSelection.querySelector('.modal-footer').style.display = 'flex'; // Show footer for challenges
        }
        
        // --- 5. GAME LOGIC ---
        
        // NEW: Timer Functions
        function startTimer(duration, onTimeout) {
            clearTimer();
            DOMElements.game.timerDisplay.classList.remove('hidden');
            app.timerSeconds = duration;
            DOMElements.game.timerDisplay.textContent = app.timerSeconds;

            app.timerInterval = setInterval(() => {
                app.timerSeconds--;
                DOMElements.game.timerDisplay.textContent = app.timerSeconds;

                if (app.timerSeconds <= 5) {
                    DOMElements.game.timerDisplay.style.color = 'var(--error-color)';
                } else {
                    DOMElements.game.timerDisplay.style.color = 'var(--timer-color)';
                }

                if (app.timerSeconds <= 0) {
                    clearTimer();
                    onTimeout();
                }
            }, 1000);
        }

        function clearTimer() {
            if (app.timerInterval) {
                clearInterval(app.timerInterval);
                app.timerInterval = null;
            }
            DOMElements.game.timerDisplay.classList.add('hidden');
            DOMElements.game.timerDisplay.textContent = '';
            DOMElements.game.timerDisplay.style.color = 'var(--timer-color)';
        }


        function updateStreak(isCorrect) {
            if (isCorrect) {
                app.currentStreak++;
                if (app.currentStreak > app.userData.longestStreak) {
                    app.userData.longestStreak = app.currentStreak;
                }
            } else {
                app.currentStreak = 0;
            }
            DOMElements.game.streakDisplay.textContent = `ğŸ”¥${app.currentStreak}`;
        }

        function updateScore(isCorrect) {
             if (isCorrect) {
                const points = 10 + Math.min(app.currentStreak, 5) * 2; // Bonus for streak
                app.currentSession.score += points;
                app.userData.stats.totalScore += points;
            } else {
                app.userData.stats.totalMistakes++;
            }
            DOMElements.game.scoreDisplay.textContent = app.currentSession.score;
            saveData();
        }

        function endSession() {
            clearTimer(); 
            
            // Stop any speaking audio
            if ('speechSynthesis' in window) speechSynthesis.cancel();
            if (DOMElements.audio.ttsFallback) { DOMElements.audio.ttsFallback.pause(); DOMElements.audio.ttsFallback.currentTime = 0; }
            
            const session = app.currentSession;
            const totalQuestions = session.questions.length;
            const accuracy = totalQuestions > 0 ? ((totalQuestions - session.mistakes.length) / totalQuestions) * 100 : 0;
            const levelKey = `${session.level}-${session.subLevel}`;

            DOMElements.modals.summary.classList.remove('hidden');
            document.getElementById('summary-score').textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${session.score}`;
            document.getElementById('summary-accuracy').textContent = `Ø§Ù„Ø¯Ù‚Ø©: ${accuracy.toFixed(1)}%`;
            DOMElements.modals.summaryReviewArea.innerHTML = '';

            // NEW: Store mistakes permanently for the common mistakes challenge
            session.mistakes.forEach(mistake => {
                // Check if the mistake (based on cleaned EN sentence) is already in permanentMistakes
                if (!app.userData.permanentMistakes.some(m => cleanString(m.en) === cleanString(mistake.en))) {
                    app.userData.permanentMistakes.push({ en: mistake.en, ar: mistake.ar });
                }
            });
            
            if (session.mistakes.length === 0) {
                 DOMElements.modals.summaryReviewArea.innerHTML = '<p style="text-align: center; color: var(--success-color); margin-top: 1rem;">Ø£Ø¯Ø§Ø¡ Ù…Ø«Ø§Ù„ÙŠ! Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡.</p>';
                 DOMElements.modals.reviewMistakesBtn.classList.add('hidden');
            } else {
                 DOMElements.modals.reviewMistakesBtn.classList.remove('hidden');
            }

            // Unlocking logic (only for regular sub-level sessions)
            if (session.subLevel !== 'Challenge' && accuracy >= UNLOCK_PERCENTAGE && !app.userData.stats.completedLevels.includes(levelKey)) {
                app.userData.stats.completedLevels.push(levelKey);
                unlockNextSubLevel(session.level, session.subLevel);
            }
            
            checkAchievements();
            saveData();
        }
        
        function unlockNextSubLevel(currentLevel, currentSubLevel) {
            const nextSubLevel = String(parseInt(currentSubLevel) + 1);
            
            // Check for next sub-level in the current main level
            if (app.sentences[currentLevel] && app.sentences[currentLevel][nextSubLevel]) {
                if (!app.userData.unlockedSubLevels[currentLevel].includes(nextSubLevel)) {
                    app.userData.unlockedSubLevels[currentLevel].push(nextSubLevel);
                    showToast(`ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${currentLevel}-${nextSubLevel}!`, 'success', 'ğŸ”“');
                    saveData();
                }
            } else {
                // Try to unlock the next main level (e.g., A2-1)
                const currentIndex = LEVELS_FILES.findIndex(l => l.level === currentLevel);
                const nextLevel = LEVELS_FILES[currentIndex + 1]?.level;

                if (nextLevel && app.sentences[nextLevel]?.['1']) {
                     if (!app.userData.unlockedSubLevels[nextLevel]) {
                         app.userData.unlockedSubLevels[nextLevel] = [];
                     }
                     if (!app.userData.unlockedSubLevels[nextLevel].includes('1')) {
                         app.userData.unlockedSubLevels[nextLevel].push('1');
                         showToast(`ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… ÙØªØ­ Ù…Ø³ØªÙˆÙ‰ ${nextLevel}!`, 'success', 'ğŸ‰');
                         saveData();
                     }
                }
            }
        }
        
        function checkAchievements() {
            // Check for FIRST_CORRECT on the first correct answer
            if (app.currentSession.score > 0 && !app.userData.achievements.FIRST_CORRECT) { 
                app.userData.achievements.FIRST_CORRECT = true;
                showToast(ACHIEVEMENTS.FIRST_CORRECT.name, 'success', ACHIEVEMENTS.FIRST_CORRECT.icon);
            }
            
            // Logic for A1/A2/B1/B2 Master achievements
            ['A1', 'A2', 'B1', 'B2'].forEach(level => {
                 const achId = `${level}_LEVEL_MASTER`;
                 if (!app.userData.achievements[achId]) {
                      const allSubLevels = Object.keys(app.sentences[level] || {});
                      const completedCount = app.userData.stats.completedLevels.filter(l => l.startsWith(`${level}-`)).length;
                      if (allSubLevels.length > 0 && completedCount === allSubLevels.length) {
                            app.userData.achievements[achId] = true;
                            showToast(ACHIEVEMENTS[achId].name, 'success', ACHIEVEMENTS[achId].icon);
                      }
                 }
            });
            saveData();
        }
        
        function reviewMistakes() {
            DOMElements.modals.summaryReviewArea.innerHTML = '<h3>Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</h3>';
            app.currentSession.mistakes.forEach(mistake => {
                const div = document.createElement('div');
                div.className = 'favorite-sentence-item';
                div.style.backgroundColor = 'var(--error-color)';
                div.style.color = 'white';
                div.style.border = 'none';
                const userAnswerText = mistake.userAnswer || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„'; 
                div.innerHTML = `<p class="en" style="color: white; font-weight: 700;">${mistake.en}</p><p class="ar" style="color: #ffdddd;">${mistake.ar}</p><p style="color: #ffdddd; font-size: 0.9rem; margin-top: 0.5rem;">Ø¥Ø¬Ø§Ø¨ØªÙƒ (${mistake.mode}): ${userAnswerText}</p>`;
                DOMElements.modals.summaryReviewArea.appendChild(div);
            });
            DOMElements.modals.reviewMistakesBtn.classList.add('hidden');
        }

        // NEW: Centralized function to disable controls after a check or timeout
        function disableGameControls() {
            clearTimer(); 
            DOMElements.game.typingInput.disabled = true;
            document.querySelectorAll('#mcq-options .btn').forEach(btn => btn.disabled = true);
            document.querySelectorAll('#word-bank .word-chip').forEach(chip => chip.onclick = null); 
            document.querySelectorAll('#word-selection-bank .word-to-select').forEach(chip => chip.onclick = null); 
            document.querySelectorAll('#ordered-sentence-area .selected-word').forEach(chip => chip.onclick = null); 
            DOMElements.game.dictationPlayBtn.disabled = true;
            
            // Disable pronunciation buttons except model playback
            if (app.currentSession?.currentModeForQuestion === 'Pronunciation') {
                DOMElements.game.recordBtn.disabled = true;
                DOMElements.game.playUserBtn.disabled = true;
                DOMElements.game.playModelBtn.disabled = false;
            }
        }

        function handleTimeout(mode) {
            disableGameControls();
            flashScreen('incorrect');
            updateStreak(false);
            updateScore(false);
            
            const sentence = app.currentSession.currentSentence;
            // Record mistake without a user answer
            if (app.currentSession.mistakes.every(m => cleanString(m.en) !== cleanString(sentence.en))) {
                app.currentSession.mistakes.push({ en: sentence.en, ar: sentence.ar, mode: mode, userAnswer: 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!' });
            }
            
            showToast('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!', 'error', 'âŒ›');
            
            // Reveal correct answer and allow moving next
            DOMElements.game.sentenceEn.textContent = sentence.en;
            DOMElements.game.sentenceEnBox.classList.remove('hidden');
            DOMElements.game.sentenceArBox.classList.remove('hidden');

            DOMElements.game.checkBtn.classList.add('hidden');
            DOMElements.game.nextBtn.classList.remove('hidden');
            speak(sentence.en);
        }


        function checkAnswer(userAnswer, optionElement = null) {
            if (!app.currentSession) return; 
            
            disableGameControls(); 

            const session = app.currentSession;
            const sentence = session.currentSentence;
            const mode = session.currentModeForQuestion;
            let isCorrect = false;
            let expectedAnswer = cleanString(sentence.en);
            
            DOMElements.game.checkBtn.classList.add('hidden');
            DOMElements.game.nextBtn.classList.remove('hidden');

            const cleanUserAnswer = cleanString(userAnswer);

            switch (mode) {
                case 'MCQ':
                case 'ListenType':
                    isCorrect = cleanUserAnswer === expectedAnswer;
                    // Highlight correct/incorrect option
                    if (optionElement) {
                        optionElement.style.backgroundColor = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                        optionElement.style.color = 'white';
                        if (!isCorrect) {
                             document.querySelectorAll('#mcq-options .btn').forEach(el => {
                                 if (cleanString(el.textContent) === expectedAnswer) {
                                      el.style.border = '2px solid var(--success-color)';
                                      el.style.backgroundColor = 'var(--success-color)';
                                      el.style.color = 'white';
                                 }
                             });
                        }
                    }
                    break;
                case 'Typing':
                case 'Dictation':
                case 'TypingChallenge': 
                    // Use a looser comparison for typing to be more forgiving
                    isCorrect = simplifyString(userAnswer) === simplifyString(sentence.en);
                    DOMElements.game.typingInput.style.borderColor = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                    DOMElements.game.sentenceEn.textContent = sentence.en; // Reveal correct answer
                    DOMElements.game.sentenceEnBox.classList.remove('hidden');
                    DOMElements.game.sentenceArBox.classList.remove('hidden');
                    break;
                case 'FillBlank':
                    const correctWordFB = session.correctFillBlankWord ? cleanString(session.correctFillBlankWord) : '';
                    isCorrect = cleanUserAnswer === correctWordFB;

                    if (optionElement) {
                        optionElement.style.backgroundColor = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                        optionElement.style.color = 'white';
                        const placeholder = document.getElementById('blank-placeholder');
                        if (placeholder) {
                            placeholder.textContent = session.correctFillBlankWord || '[Word]';
                            placeholder.style.color = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                        }
                    }
                    DOMElements.game.sentenceEnBox.classList.remove('hidden'); // Reveal English sentence
                    break;
                case 'OrderWords':
                    isCorrect = simplifyString(userAnswer) === simplifyString(sentence.en);
                    DOMElements.game.orderedSentenceArea.style.border = isCorrect ? '2px solid var(--success-color)' : '2px solid var(--error-color)';
                    DOMElements.game.sentenceEn.textContent = sentence.en; // Reveal correct answer
                    DOMElements.game.sentenceEnBox.classList.remove('hidden');
                    break;
                default:
                    return;
            }

            if (isCorrect) {
                playSound('success');
                flashScreen('correct');
                updateStreak(true);
                updateScore(true);
            } else {
                playSound('fail');
                flashScreen('incorrect');
                updateStreak(false);
                if (session.mistakes.every(m => cleanString(m.en) !== cleanString(sentence.en))) {
                    session.mistakes.push({ en: sentence.en, ar: sentence.ar, mode: mode, userAnswer: userAnswer });
                }
                updateScore(false);
            }
            
            // Speak the correct English sentence after check
            speak(sentence.en);
        }
        
        function renderQuestion() {
            clearTimer(); 

            if (app.currentSession.currentIndex >= app.currentSession.questions.length) return endSession();
            
            const sentence = app.currentSession.questions[app.currentSession.currentIndex];
            if (!sentence.hint) sentence.hint = ''; 
            app.currentSession.currentSentence = sentence;
            
            updateFavoriteButton(); 
            DOMElements.gameScreen.dataset.sessionMode = app.currentSession.mode;
            
            DOMElements.game.sessionProgressBar.style.width = `${(Math.min(app.currentSession.currentIndex + 1, app.currentSession.questions.length) / app.currentSession.questions.length) * 100}%`;
            
            // --- UI RESET ---
            DOMElements.game.sentenceEn.textContent = '';
            DOMElements.game.sentenceAr.textContent = sentence.ar;
            DOMElements.game.typingInput.value = '';
            DOMElements.game.typingInput.disabled = false;
            DOMElements.game.typingInput.style.borderColor = 'var(--border-color)';
            
            // Hide all mode containers and control buttons
            ['mcq-container', 'typing-container', 'listen-container', 'fill-blank-container', 'order-words-container', 'dictation-container', 'pronunciation-container'].forEach(c => document.getElementById(c).classList.add('hidden'));
            DOMElements.game.nextBtn.classList.add('hidden');
            DOMElements.game.checkBtn.classList.remove('hidden');
            DOMElements.game.typingInput.style.textAlign = 'left'; 
            DOMElements.game.dictationPlayBtn.disabled = false;
            
            // By default, show both boxes (will be hidden/shown by mode)
            DOMElements.game.sentenceEnBox.classList.remove('hidden');
            DOMElements.game.sentenceArBox.classList.remove('hidden');
            DOMElements.game.replaySoundBtn.onclick = () => speak(sentence.en); 
            
            let mode = app.currentSession.mode;
            if (mode === 'Challenge') {
                const availableModes = ['MCQ', 'Typing', 'ListenType', 'FillBlank', 'OrderWords', 'Dictation', 'TypingChallenge', 'Pronunciation']; 
                mode = availableModes[Math.floor(Math.random() * availableModes.length)];
            }
            app.currentSession.currentModeForQuestion = mode;
            
            app.orderWordsUserSequence = [];
            DOMElements.game.orderedSentenceArea.innerHTML = '';
            DOMElements.game.wordSelectionBank.innerHTML = '';
            
            // Reset pronunciation state
            if (app.userAudioURL) { URL.revokeObjectURL(app.userAudioURL); app.userAudioURL = null; }
            DOMElements.game.recordBtn.textContent = 'ğŸ¤';
            DOMElements.game.recordBtn.classList.remove('btn-secondary');
            DOMElements.game.playUserBtn.disabled = true;

            // --- MODE SETUP ---
            switch (mode) {
                case 'Learning':
                    DOMElements.game.sentenceEn.textContent = sentence.en;
                    DOMElements.game.typingContainer.classList.remove('hidden');
                    DOMElements.game.typingInput.placeholder = "Ø§ÙƒØªØ¨ Ù„Ù„Ù…Ù…Ø§Ø±Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)";
                    DOMElements.game.checkBtn.classList.add('hidden');
                    DOMElements.game.nextBtn.classList.remove('hidden');
                    speak(sentence.en);
                    break;
                case 'MCQ':
                case 'ListenType': 
                    DOMElements.game.mcqContainer.classList.remove('hidden');
                    DOMElements.game.mcqOptions.innerHTML = '';
                    
                    if (mode === 'ListenType') {
                        DOMElements.game.sentenceEnBox.classList.add('hidden'); 
                        DOMElements.game.listenContainer.classList.remove('hidden');
                        DOMElements.game.playAudioBtn.onclick = () => speak(sentence.en);
                        speak(sentence.en); 
                    } else { // MCQ (Translation mode EN -> AR)
                        DOMElements.game.sentenceEnBox.classList.add('hidden'); 
                    }

                    startTimer(TIMER_DURATION_SEC, () => handleTimeout(mode));

                    const allSentences = Object.values(app.sentences).flatMap(levels => Object.values(levels)).flat();
                    const incorrectSentences = shuffleArray(allSentences.filter(s => cleanString(s.en) !== cleanString(sentence.en))).slice(0, 3);
                    const options = shuffleArray([sentence.en, ...incorrectSentences.map(s => s.en)]);
                    
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.textContent = opt;
                        btn.onclick = (e) => checkAnswer(opt, e.target); 
                        DOMElements.game.mcqOptions.appendChild(btn);
                    });
                    DOMElements.game.checkBtn.classList.add('hidden');
                    break;
                case 'Typing':
                    DOMElements.game.typingContainer.classList.remove('hidden');
                    DOMElements.game.typingInput.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©...";
                    DOMElements.game.sentenceEnBox.classList.add('hidden'); 
                    DOMElements.game.typingInput.focus();
                    break;
                case 'TypingChallenge': 
                    DOMElements.game.typingContainer.classList.remove('hidden');
                    DOMElements.game.sentenceEn.textContent = sentence.en; 
                    DOMElements.game.typingInput.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø¨Ø³Ø±Ø¹Ø©!";
                    DOMElements.game.sentenceArBox.classList.add('hidden'); 
                    
                    startTimer(TYPING_CHALLENGE_DURATION_SEC, () => handleTimeout(mode));

                    DOMElements.game.typingInput.focus();
                    break;
                case 'Dictation': 
                    DOMElements.game.dictationContainer.classList.remove('hidden');
                    DOMElements.game.typingContainer.classList.remove('hidden'); 
                    DOMElements.game.typingInput.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©...";
                    DOMElements.game.typingInput.style.textAlign = 'center'; 
                    // Hide both for true dictation
                    DOMElements.game.sentenceEnBox.classList.add('hidden'); 
                    DOMElements.game.sentenceArBox.classList.add('hidden'); 
                    
                    DOMElements.game.dictationPlayBtn.onclick = () => speak(sentence.en);
                    speak(sentence.en);
                    DOMElements.game.typingInput.focus();
                    break;
                case 'Pronunciation':
                    DOMElements.game.pronunciationContainer.classList.remove('hidden');
                    DOMElements.game.sentenceEn.textContent = sentence.en; // Show EN
                    DOMElements.game.sentenceArBox.classList.remove('hidden'); // Show AR
                    DOMElements.game.checkBtn.classList.add('hidden'); 
                    DOMElements.game.nextBtn.classList.remove('hidden');
                    DOMElements.game.playModelBtn.disabled = false;
                    DOMElements.game.recordBtn.disabled = false;
                    
                    // Auto-play model sound
                    speak(sentence.en); 
                    break;
                case 'FillBlank':
                    DOMElements.game.fillBlankContainer.classList.remove('hidden');
                    DOMElements.game.wordBank.innerHTML = '';
                    DOMElements.game.sentenceEnBox.classList.add('hidden'); 
                    
                    startTimer(TIMER_DURATION_SEC, () => handleTimeout(mode));

                    const wordsFB = sentence.en.match(/\b(\w+'?\w*)\b|[^a-zA-Z\s]/g) || [];
                    const wordIndices = wordsFB.map((w, i) => (/\w/.test(w) ? i : -1)).filter(i => i !== -1);
                    
                    if (wordIndices.length < 2) { 
                        DOMElements.game.wordBlanks.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù…Ù„Ø© (Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº).";
                        DOMElements.game.checkBtn.classList.add('hidden');
                        DOMElements.game.nextBtn.classList.remove('hidden');
                        clearTimer();
                        return;
                    }
                    
                    const blankIndex = wordIndices[Math.floor(Math.random() * wordIndices.length)];
                    const correctWordFB = wordsFB[blankIndex].replace(/[^a-zA-Z\s]/g, ''); 
                    app.currentSession.correctFillBlankWord = correctWordFB; 

                    const displayedSentence = [...wordsFB];
                    displayedSentence[blankIndex] = `<span id="blank-placeholder" style="color:var(--text-secondary); padding: 0 10px;">[....]</span>`;
                    
                    DOMElements.game.wordBlanks.innerHTML = displayedSentence.join(' ').replace(/\s([.,?!;])/g, '$1');
                    
                    
                    const allWords = Object.values(app.sentences).flatMap(levels => Object.values(levels)).flat().flatMap(s => s.en.match(/\b(\w+'?\w*)\b/g) || []).map(w => w.replace(/[^a-zA-Z\s]/g, ''));
                    const incorrectWordsFB = shuffleArray(Array.from(new Set(allWords.filter(w => cleanString(w) !== cleanString(correctWordFB) && w.trim() !== '')))).slice(0, 3);
                    const bankWordsFB = shuffleArray([correctWordFB, ...incorrectWordsFB].filter(w => w.trim() !== ''));
                    
                    bankWordsFB.forEach(word => {
                        const chip = document.createElement('div');
                        chip.className = 'word-chip';
                        chip.textContent = word;
                        chip.onclick = () => {
                            checkAnswer(word, chip);
                        };
                        DOMElements.game.wordBank.appendChild(chip);
                    });
                    DOMElements.game.checkBtn.classList.add('hidden');
                    break;
                case 'OrderWords':
                    DOMElements.game.orderWordsContainer.classList.remove('hidden');
                    DOMElements.game.sentenceEnBox.classList.add('hidden'); 
                    
                    startTimer(TIMER_DURATION_SEC, () => handleTimeout(mode));
                    
                    const wordsOW = sentence.en.match(/\b(\w+'?\w*)\b|[^a-zA-Z\s]/g) || [];
                    
                    const chipsForShuffling = wordsOW.filter(w => w.trim() !== '').map(w => w.replace(/[^a-zA-Z\s]/g, ''));
                    const shuffledWordsOW = shuffleArray(chipsForShuffling);

                    shuffledWordsOW.forEach((word, index) => {
                        const chip = document.createElement('div');
                        chip.className = 'word-to-select';
                        chip.textContent = word;
                        chip.dataset.uniqueId = `${index}-${word}`; 
                        chip.onclick = () => selectWord(chip, word);
                        DOMElements.game.wordSelectionBank.appendChild(chip);
                    });
                    DOMElements.game.checkBtn.classList.remove('hidden');
                    break;
            }
        }

        function selectWord(chip, word) {
            playSound('click');
            chip.classList.add('hidden');
            const selectedChip = document.createElement('div');
            selectedChip.className = 'selected-word';
            selectedChip.textContent = word;
            selectedChip.dataset.uniqueId = chip.dataset.uniqueId; 
            selectedChip.onclick = () => unselectWord(selectedChip);
            DOMElements.game.orderedSentenceArea.appendChild(selectedChip);
            
            app.orderWordsUserSequence.push(word);
        }

        function unselectWord(selectedChip) {
            playSound('click');
            
            const originalChip = document.querySelector(`#word-selection-bank .word-to-select[data-unique-id="${selectedChip.dataset.uniqueId}"]`);
            if (originalChip) {
                originalChip.classList.remove('hidden');
            }
            
            const wordToRemove = selectedChip.textContent;
            const indexInSequence = app.orderWordsUserSequence.indexOf(wordToRemove);
            if (indexInSequence > -1) {
                app.orderWordsUserSequence.splice(indexInSequence, 1);
            }
            selectedChip.remove();
        }

        function showModeSelectionModal(level, subLevel) {
            vibrate();
            playSound('click');
            app.pendingSession = { level, subLevel };
            renderModeSelectionButtons();
            DOMElements.modals.modeSelection.classList.remove('hidden');
        }
        
        // NEW: Function to handle Thematic Challenge selection
        function showThematicSelectionModal() {
            // Collect all unique topics (case-insensitive and trimmed)
            const allTopics = Array.from(new Set(
                Object.values(app.sentences).flatMap(levels => 
                    Object.values(levels)).flat().map(s => s.topic).filter(t => t)
            )).map(t => t.trim());
            
            if (allTopics.length === 0) {
                 DOMElements.modals.modeSelection.classList.add('hidden');
                 showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ù…Ù„.', 'error', 'âš ï¸');
                 // Restore the main mode selection view
                 setTimeout(() => { DOMElements.modals.modeSelection.classList.remove('hidden'); renderModeSelectionButtons(); }, 500);
                 return;
            }

            // Temporarily replace modal body content for theme selection
            const content = allTopics.map(topic => 
                `<button class="btn theme-btn" data-theme="${topic}">${topic}</button>`
            ).join('');

            DOMElements.modals.modeSelectionButtons.innerHTML = content;
            DOMElements.modals.modeSelection.querySelector('.modal-header .modal-title').textContent = 'ğŸŒ Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ø§Ù‹';
            DOMElements.modals.modeSelection.querySelector('.modal-footer').style.display = 'none'; // Hide challenge buttons

            // Event listener for theme selection (must be added after innerHTML update)
            const listener = (e) => {
                if (e.target.matches('[data-theme]')) {
                    startSession('Thematic', { theme: e.target.dataset.theme });
                    DOMElements.modals.modeSelection.classList.add('hidden');
                    // Remove the temporary listener and restore main buttons
                    DOMElements.modals.modeSelectionButtons.removeEventListener('click', listener);
                }
            };
            DOMElements.modals.modeSelectionButtons.addEventListener('click', listener);
        }


        // --- FAVORITES, STATS, SETTINGS (Updated) ---
        
        function updateFavoriteButton() {
            if (!app.currentSession || !app.currentSession.currentSentence) {
                DOMElements.game.favBtn.classList.add('hidden');
                return;
            }
            DOMElements.game.favBtn.classList.remove('hidden');
            const currentSentence = app.currentSession.currentSentence;
            const isFavorite = app.userData.favorites.some(fav => cleanString(fav.en) === cleanString(currentSentence.en));
            DOMElements.game.favBtn.textContent = isFavorite ? 'â¤ï¸' : 'ğŸ¤';
            DOMElements.game.favBtn.title = isFavorite ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©';
        }

        function toggleFavorite() {
            playSound('click');
            vibrate(50);
            if (!app.currentSession || !app.currentSession.currentSentence) return;
            
            const currentSentence = { 
                en: app.currentSession.currentSentence.en, 
                ar: app.currentSession.currentSentence.ar,
            };
            const currentSentenceClean = cleanString(currentSentence.en);
            
            const index = app.userData.favorites.findIndex(fav => cleanString(fav.en) === currentSentenceClean);
            
            if (index > -1) {
                app.userData.favorites.splice(index, 1);
                showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø© ğŸ—‘ï¸', 'info', 'ğŸ¤');
            } else {
                app.userData.favorites.push(currentSentence);
                showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©! â¤ï¸', 'success', 'â¤ï¸');
            }
            
            saveData();
            updateFavoriteButton();
        }
        
        // ... (showFavorites, showSettings, showAboutSection, showStats, showAchievements are largely unchanged)

        function startSession(mode, optionalData = {}) {
            let level = app.pendingSession.level;
            let subLevel = app.pendingSession.subLevel;
            vibrate();
            playSound('click');
            
            let questions = [];
            
            if (mode === 'CommonMistakes') {
                // Get permanent mistakes and map them to the standard question object structure
                questions = shuffleArray(app.userData.permanentMistakes.map(m => ({ en: m.en, ar: m.ar, hint: '', subLevel: 'Challenge', topic: 'Mistakes' })));
                level = 'Challenge'; // Use 'Challenge' as level for summary
                subLevel = 'Mistakes';
                if (questions.length === 0) {
                    DOMElements.modals.modeSelection.classList.add('hidden');
                    showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø© Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!', 'error', 'âŒ');
                    return;
                }
            } else if (mode === 'Thematic') {
                const theme = optionalData.theme;
                const allSentences = Object.values(app.sentences).flatMap(levels => Object.values(levels)).flat();
                
                // Filter sentences by the 'topic' field (case-insensitive)
                questions = shuffleArray(allSentences.filter(s => cleanString(s.topic || '') === cleanString(theme)));
                
                level = 'Challenge';
                subLevel = theme;
                
                if (questions.length === 0) {
                    DOMElements.modals.modeSelection.classList.add('hidden');
                    showToast(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù…Ù„ Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹: ${theme}`, 'error', 'âš ï¸');
                    return;
                }
            } else {
                questions = app.sentences[level]?.[subLevel] ? 
                              shuffleArray([...app.sentences[level][subLevel]]) : [];
            }


            if (questions.length === 0) {
                 DOMElements.modals.modeSelection.classList.add('hidden');
                 showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù…Ù„ Ù…ØªÙˆÙØ±Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©.', 'error', 'âš ï¸');
                 return;
            }

            app.currentStreak = 0;
            
            app.currentSession = {
                level, subLevel, mode,
                questions,
                currentIndex: 0, score: 0, mistakes: [],
                correctFillBlankWord: null, 
            };
            DOMElements.game.scoreDisplay.textContent = '0';
            DOMElements.game.streakDisplay.textContent = 'ğŸ”¥0';
            DOMElements.modals.modeSelection.classList.add('hidden');
            showScreen('game-screen');
            renderQuestion();
        }

        // --- 6. EVENT LISTENERS ---
        function setupEventListeners() {
            // ... (Existing Event Listeners)
            document.getElementById('settings-btn').onclick = () => { playSound('click'); vibrate(); showSettings(); };
            document.getElementById('stats-btn').onclick = () => { playSound('click'); vibrate(); showStats(); };
            document.getElementById('achievements-btn').onclick = () => { playSound('click'); vibrate(); showAchievements(); };
            DOMElements.genericScreen.backBtn.onclick = () => { 
                playSound('click'); 
                vibrate(); 
                renderMainMenu(); 
            };
            document.getElementById('back-to-menu-btn').onclick = () => { 
                if ('speechSynthesis' in window) speechSynthesis.cancel();
                if (DOMElements.audio.ttsFallback) { DOMElements.audio.ttsFallback.pause(); DOMElements.audio.ttsFallback.currentTime = 0; }
                clearTimer(); 
                playSound('click'); 
                renderMainMenu(); 
            };

            document.getElementById('summary-close-btn').onclick = () => { 
                playSound('click'); 
                DOMElements.modals.summary.classList.add('hidden'); 
                renderMainMenu(); 
            };
            DOMElements.modals.reviewMistakesBtn.onclick = () => { playSound('click'); reviewMistakes(); };


            document.querySelector('#mode-selection-modal .modal-overlay').onclick = () => { 
                playSound('click'); 
                DOMElements.modals.modeSelection.classList.add('hidden'); 
                // Restore main buttons state if thematic selection was active
                renderModeSelectionButtons();
            };
            DOMElements.modals.modeSelectionButtons.addEventListener('click', e => {
                if (e.target.matches('[data-mode]')) startSession(e.target.dataset.mode);
            });
            
            // NEW Challenge buttons listeners
            DOMElements.modals.commonMistakesBtn.onclick = () => {
                 playSound('click');
                 startSession('CommonMistakes');
            };
            DOMElements.modals.thematicChallengeBtn.onclick = () => {
                 playSound('click');
                 showThematicSelectionModal();
            };

            // ... (rest of controls listeners)
            DOMElements.game.checkBtn.onclick = () => {
                playSound('click');
                const mode = app.currentSession?.currentModeForQuestion;
                if (mode === 'Typing' || mode === 'Dictation' || mode === 'TypingChallenge') { 
                    checkAnswer(DOMElements.game.typingInput.value);
                } else if (mode === 'OrderWords') {
                    checkAnswer(app.orderWordsUserSequence.join(' ')); 
                }
            };
            DOMElements.game.nextBtn.onclick = () => { 
                if ('speechSynthesis' in window) speechSynthesis.cancel();
                if (DOMElements.audio.ttsFallback) { DOMElements.audio.ttsFallback.pause(); DOMElements.audio.ttsFallback.currentTime = 0; }
                
                clearTimer(); 
                DOMElements.game.typingInput.disabled = false;
                DOMElements.game.typingInput.style.borderColor = 'var(--border-color)';
                playSound('click'); 
                app.currentSession.currentIndex++; 
                renderQuestion(); 
            };
            
            DOMElements.game.favBtn.onclick = toggleFavorite;
            
            DOMElements.game.typingInput.addEventListener('keydown', (e) => {
                const mode = app.currentSession?.currentModeForQuestion;
                if (e.key === 'Enter' && (mode === 'Typing' || mode === 'Dictation' || mode === 'TypingChallenge') && !DOMElements.game.checkBtn.classList.contains('hidden')) {
                    e.preventDefault();
                    DOMElements.game.checkBtn.click();
                }
            });
            
            // --- NEW: Pronunciation Listeners ---
            DOMElements.game.playModelBtn.onclick = () => {
                if (app.currentSession && app.currentSession.currentSentence) {
                    speak(app.currentSession.currentSentence.en);
                }
            };
            
            // Play the user's recorded audio
            DOMElements.game.playUserBtn.onclick = () => {
                if (app.userAudioURL) {
                    const userAudio = DOMElements.audio.userPlayback;
                    userAudio.src = app.userAudioURL; // Set the recorded audio blob URL
                    userAudio.currentTime = 0;
                    userAudio.play();
                }
            };
            
            // Record button logic
            DOMElements.game.recordBtn.onclick = async () => {
                if (app.mediaRecorder && app.mediaRecorder.state === 'recording') {
                    // STOP recording
                    app.mediaRecorder.stop();
                    DOMElements.game.recordBtn.textContent = 'ğŸ¤';
                    DOMElements.game.recordBtn.classList.remove('btn-secondary');
                    return;
                }
                
                // START recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    app.mediaRecorder = new MediaRecorder(stream);
                    app.audioChunks = [];
                    
                    app.mediaRecorder.ondataavailable = event => { app.audioChunks.push(event.data); };
                    
                    app.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(app.audioChunks, { type: 'audio/webm' }); // Use webm for broader compatibility
                        if (app.userAudioURL) URL.revokeObjectURL(app.userAudioURL); 
                        app.userAudioURL = URL.createObjectURL(audioBlob);
                        DOMElements.game.playUserBtn.disabled = false;
                        showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„! Ù‚Ø§Ø±Ù† Ù†Ø·Ù‚Ùƒ Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.', 'info', 'ğŸ™ï¸');
                        stream.getTracks().forEach(track => track.stop()); // Stop mic usage
                    };
                    
                    app.mediaRecorder.start();
                    DOMElements.game.recordBtn.textContent = 'â– '; // Stop icon
                    DOMElements.game.recordBtn.classList.add('btn-secondary');
                    DOMElements.game.playUserBtn.disabled = true;
                    showToast('Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...', 'success', 'ğŸ¤');
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    showToast('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø¥Ø°Ù†.', 'error', 'ğŸš«');
                }
            };
        }

        // --- 7. INITIALIZATION ---
        async function init() {
            if (app.isInitialized) return;
            app.isInitialized = true;
            loadData();
            document.body.dataset.theme = app.settings.theme;

            // Initialize TTS voices
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => { app.ttsVoices = speechSynthesis.getVoices(); };
                app.ttsVoices = speechSynthesis.getVoices(); 
            }

            // Load data from JSON files
            let allFilesLoaded = true;
            for(let i=0; i < LEVELS_FILES.length; i++) {
                const { level, file } = LEVELS_FILES[i];
                try {
                    document.getElementById('loading-status').textContent = `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø³ØªÙˆÙ‰ ${level} Ù…Ù† ${file}...`;
                    const response = await fetch(file); 
                    if(!response.ok) throw new Error(`Failed to load ${file}: ${response.statusText}`);
                    const data = await response.json();
                    
                    app.sentences[level] = {};
                    for (let j = 0; j < data.length; j += SUB_LEVEL_SIZE) {
                        const subLevelKey = String(Math.floor(j / SUB_LEVEL_SIZE) + 1);
                        const sentencesChunk = data.slice(j, j + SUB_LEVEL_SIZE).map(s => ({
                            ...s, 
                            subLevel: subLevelKey,
                            hint: s.hint || '',
                            topic: s.topic || null, // Ensure topic field exists
                        }));
                        app.sentences[level][subLevelKey] = sentencesChunk;
                    }

                } catch(e) { 
                    allFilesLoaded = false;
                    document.getElementById('loading-status').textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ${file}. (ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯)`;
                    console.error(`Initialization Error: Could not load data for ${level}`, e);
                    if (app.sentences[level] === undefined) { 
                        app.sentences[level] = {};
                    }
                }
                document.getElementById('loading-progress').style.width = `${((i+1)/LEVELS_FILES.length) * 100}%`;
            }
            
            document.getElementById('loading-status').textContent = allFilesLoaded ? `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­.` : `ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.`;
            
            // Ensure A1-1 is unlocked by default if data for A1 exists
            if (app.sentences['A1'] && Object.keys(app.sentences['A1']).length > 0) {
                 if (!app.userData.unlockedSubLevels['A1'] || !app.userData.unlockedSubLevels['A1'].includes('1')) {
                      app.userData.unlockedSubLevels['A1'] = ['1'];
                      saveData();
                 }
            }


            setupEventListeners();
            DOMElements.splashScreen.style.opacity = '0';
            setTimeout(() => { DOMElements.splashScreen.classList.add('hidden'); renderMainMenu(); }, 800);
        }
        
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>

