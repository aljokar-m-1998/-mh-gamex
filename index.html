<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="English Sentences Journey - An interactive game to learn English sentences from A1 to B2 levels.">
    <title>English Sentences Journey | M.H.</title>
    <style>
        /*
         * UI Enhancement: Advanced Professional Design (Soft UI / Neumorphism style combined with Flat)
         */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap');

        :root {
            --font-ar: 'Cairo', sans-serif;
            --font-en: 'Poppins', sans-serif;
            
            /* Light Theme - Soft, Clean, Professional */
            --bg-light: #f7f9fc;
            --surface-light: #ffffff;
            --text-primary-light: #183153;
            --text-secondary-light: #6b7c93;
            --accent-light: #3e7bff; /* Primary Blue */
            --border-light: #e6eaf0;
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.08); /* Soft shadow */
            --inner-shadow-light: inset 0 2px 4px rgba(0, 0, 0, 0.05);

            /* Dark Theme - Deep, Modern, High Contrast */
            --bg-dark: #1f2a38;
            --surface-dark: #2c3a4b;
            --text-primary-dark: #eef2f6;
            --text-secondary-dark: #a9b5c3;
            --accent-dark: #5c97ff; 
            --border-dark: #405060;
            --shadow-dark: 0 5px 15px rgba(0, 0, 0, 0.4);
            --inner-shadow-dark: inset 0 2px 4px rgba(0, 0, 0, 0.25);

            /* Level Colors */
            --a1-color: #4CAF50; /* Green */
            --a2-color: #2196F3; /* Blue */
            --b1-color: #FF9800; /* Orange */
            --b2-color: #9C27B0; /* Purple */

            /* Feedback Colors */
            --success-color: #28a745;
            --error-color: #dc3545;
            
            /* Apply theme */
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --accent: var(--accent-light);
            --border-color: var(--border-light);
            --box-shadow: var(--shadow-light);
            --inner-box-shadow: var(--inner-shadow-light);
        }
        
        body[data-theme="dark"] {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --accent: var(--accent-dark);
            --border-color: var(--border-dark);
            --box-shadow: var(--shadow-dark);
            --inner-box-shadow: var(--inner-shadow-dark);
        }
        
        /* Visual Feedback */
        body.correct-flash { animation: flashGreen 0.3s ease-in-out; }
        body.incorrect-flash { animation: flashRed 0.3s ease-in-out; }
        @keyframes flashGreen { from { background-color: var(--success-color); } to { background-color: var(--bg); } }
        @keyframes flashRed { from { background-color: var(--error-color); } to { background-color: var(--bg); } }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-ar), var(--font-en), sans-serif;
            background-color: var(--bg); color: var(--text-primary);
            line-height: 1.6; transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        #app { max-width: 800px; margin: 0 auto; padding: 1.5rem; min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Professional Buttons and Inputs */
        .btn {
            display: inline-flex; justify-content: center; align-items: center; gap: 0.5rem;
            padding: 1rem 2rem; font-size: 1rem; font-weight: 600;
            border-radius: 12px; border: none; cursor: pointer; transition: all 0.2s ease-in-out;
            background-color: var(--accent); color: white; text-decoration: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Soft button shadow */
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
        .btn-secondary { 
            background-color: var(--text-secondary); color: var(--bg); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover { box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        .btn-icon { 
            background: var(--surface); border: 1px solid var(--border-color); 
            font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: 0.75rem; 
            border-radius: 12px; transition: all 0.2s; box-shadow: var(--box-shadow);
        }
        .btn-icon:hover { color: var(--accent); background-color: var(--bg); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); }
        
        .screen { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Main Menu Screen */
        #main-menu-screen header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
        #main-title { font-size: 2.2rem; font-weight: 700; color: var(--accent); }
        #main-menu-controls { display: flex; gap: 0.75rem; }
        
        #level-container { display: flex; flex-direction: column; gap: 2rem; }
        .level-card { 
            background-color: var(--surface); border-radius: 20px; padding: 2rem; 
            border: 1px solid var(--border-color); box-shadow: var(--shadow-light); 
            transition: all 0.3s; 
        }
        body[data-theme="dark"] .level-card { box-shadow: var(--shadow-dark); }
        .level-card.locked { opacity: 0.6; pointer-events: none; }
        
        .level-card-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; }
        .level-icon { font-size: 3rem; }
        .level-name { font-size: 1.8rem; font-weight: 700; }
        
        /* Sub-Level Grid - Always visible and active */
        .sub-level-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); 
            gap: 1.25rem; 
            padding-top: 1.5rem; 
            border-top: 1px dashed var(--border-color); 
        }
        .sub-level {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 80px; height: 80px; border-radius: 50%; 
            border: 4px solid var(--border-color);
            font-weight: 700; font-size: 1.4rem; cursor: pointer; position: relative;
            background-color: var(--surface); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        .sub-level:hover { 
            transform: scale(1.1); 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); 
            border-color: var(--accent); 
        }
        .sub-level.completed { border-color: var(--success-color); color: var(--success-color); }
        .sub-level.locked { cursor: not-allowed; background-color: var(--border-color); color: var(--text-secondary); opacity: 0.8; }

        /* Game Screen */
        #game-screen header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        
        #sentence-container { 
            background: var(--surface); padding: 2.5rem 2rem; border-radius: 20px; margin-bottom: 2rem; 
            min-height: 180px; display: flex; flex-direction: column; justify-content: center; 
            box-shadow: var(--box-shadow); text-align: center;
        }
        #sentence-en { font-family: var(--font-en); font-size: 1.8rem; font-weight: 700; margin-bottom: 0.75rem; text-align: left; }
        #sentence-ar { font-family: var(--font-ar); font-size: 1.4rem; color: var(--text-secondary); }
        
        /* Dictation/Typing input */
        #typing-container, #dictation-container { margin-top: 1rem; }
        #typing-input { 
            width: 100%; padding: 1.2rem; font-size: 1.4rem; border-radius: 15px; 
            border: 2px solid var(--border-color); background: var(--surface); color: var(--text-primary); 
            text-align: left; transition: border-color 0.3s; box-shadow: var(--inner-box-shadow);
        }
        #typing-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 4px rgba(62, 123, 255, 0.3); }

        /* Dictation Word Display */
        #dictation-word-display { 
            font-family: var(--font-en); font-size: 2.5rem; font-weight: 700; color: var(--accent); 
            margin-bottom: 1.5rem; min-height: 40px;
        }

        /* Game Controls */
        #game-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 2.5rem; }
        #game-controls-left { display: flex; gap: 1rem; }

        /* Mode Selection Modal - Enhanced Layout */
        .modal { 
            padding: 2.5rem; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }
        #mode-selection-modal .modal-title { color: var(--accent); font-size: 1.8rem; }
        #mode-selection-modal .modal-body { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 400px) { #mode-selection-modal .modal-body { grid-template-columns: 1fr 1fr; } }
        
        /* Generic Screens */
        .setting-row, .about-section {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.5rem; background-color: var(--surface);
            border-radius: 15px; margin-bottom: 1rem;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }
        .about-section { flex-direction: column; align-items: flex-start; gap: 1rem; line-height: 1.9; }
        .about-section ul { margin-right: 1.5rem; list-style-type: 'ğŸ‘‰ '; padding-right: 1rem;}
        .about-section li { margin-bottom: 0.5rem; }
        
        /* Toast Notifications */
        .toast {
            bottom: 30px; 
            box-shadow: var(--shadow-dark); 
            font-weight: 600;
        }

        /* --- NEW: Popover Styles --- */
        #sub-level-popover {
            position: absolute;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow-dark);
            z-index: 1000;
            border: 1px solid var(--border-color);
            width: 240px; 
            overflow: hidden;
            animation: popoverFadeIn 0.2s ease-out;
            transform-origin: top center;
        }
        #popover-content {
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #popover-content .btn {
            width: 100%;
            padding: 0.75rem 1rem;
            justify-content: flex-start; 
            margin: 0;
            font-size: 0.95rem;
        }
        @keyframes popoverFadeIn {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        /* --- END NEW --- */

        /* --- NEW: Word Game Styles (FillBlank, OrderWords) --- */
        #ordered-sentence-area {
            min-height: 80px; 
            background: var(--bg); 
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex; 
            flex-wrap: wrap;
            gap: 0.5rem;
            transition: border-color 0.3s;
        }
        .ordered-word-chip, .word-to-select, .word-chip {
            padding: 0.75rem 1.25rem;
            background: var(--surface);
            color: var(--text-primary);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--box-shadow);
            font-weight: 600;
            user-select: none;
        }
        .word-to-select:hover, .word-chip:hover {
            background-color: var(--accent);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .ordered-word-chip {
            background: var(--accent);
            color: white;
            box-shadow: none;
        }
        .ordered-word-chip:hover {
             background-color: var(--error-color); /* Hover to remove */
             transform: scale(1.05);
        }
        .word-to-select.disabled {
            opacity: 0.4;
            pointer-events: none;
            background: var(--border-color);
            box-shadow: none;
        }
        #word-selection-bank, #word-bank {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            margin-top: 1.5rem;
        }
        /* --- END NEW --- */
    </style>
</head>
<body data-theme="light">

    <div id="app">
        <div id="splash-screen"><h1 id="splash-title">English Sentences Journey</h1><div id="loading-bar"><div id="loading-progress"></div></div><p id="loading-status"></p></div>
        <div id="main-menu-screen" class="screen hidden"><header><h1 id="main-title">Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</h1><div id="main-menu-controls"><button id="achievements-btn" class="btn-icon" title="Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª">ğŸ†</button><button id="stats-btn" class="btn-icon" title="Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">ğŸ“Š</button><button id="settings-btn" class="btn-icon" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button></div></header><main><h2 style="margin-bottom: 1.5rem; font-weight: 700;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h2><div id="level-container"></div></main></div>
        <div id="game-screen" class="screen hidden"><header><button id="back-to-menu-btn" class="btn-icon" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©">â†©ï¸</button><div id="session-progress-bar"><div id="session-progress-fill"></div></div><div id="score-display">0</div><div id="streak-display">ğŸ”¥0</div></header><main><div id="sentence-container"><p id="sentence-en"></p><p id="sentence-ar"></p></div><div id="game-mode-container">
            <div id="typing-container" class="hidden"><input type="text" id="typing-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©..."></div>
            <div id="dictation-container" class="hidden" style="text-align: center;">
                <div id="dictation-word-display" style="text-align: center;">?</div>
            </div>
            
            <div id="mcq-container" class="hidden"><div id="mcq-options"></div></div>
            <div id="listen-container" class="hidden" style="text-align: center; margin-bottom: 1rem;"><button id="play-sound-btn" class="btn-icon" style="font-size: 2.5rem; padding: 1.2rem; border-radius: 50%;">ğŸ”Š</button></div>
            
            <div id="fill-blank-container" class="hidden"><div id="word-blanks"></div><div id="word-bank"></div></div>
            <div id="order-words-container" class="hidden">
                <div id="ordered-sentence-area"></div>
                <div id="word-selection-bank"></div>
            </div>
        </div><div id="game-controls"><div id="game-controls-left"><button id="hint-btn" class="btn btn-secondary">ğŸ’¡ ØªÙ„Ù…ÙŠØ­</button><button id="fav-btn" class="btn-icon">ğŸ¤</button><button id="replay-sound-btn" class="btn-icon" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚">ğŸ”Š</button></div><button id="check-btn" class="btn">ØªØ­Ù‚Ù‚</button><button id="next-btn" class="btn hidden">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button></div></main></div>
        <div id="generic-screen" class="screen hidden" style="animation: slideIn 0.4s;"><header><button id="generic-back-btn" class="btn-icon">â†©ï¸</button><h2 id="generic-title"></h2></header><main id="generic-content"></main></div>

        <div id="summary-modal" class="hidden"><div class="modal-overlay"></div><div class="modal"><div class="modal-header"><h2 class="modal-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø©</h2></div><div class="modal-body"><p id="summary-score"></p><p id="summary-accuracy"></p></div><div class="modal-footer"><button id="review-mistakes-btn" class="btn btn-secondary">Ø±Ø§Ø¬Ø¹ Ø£Ø®Ø·Ø§Ø¦ÙŠ</button><button id="summary-close-btn" class="btn">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>
        
        <div id="mode-selection-modal" class="hidden">
            <div class="modal-overlay"></div>
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h2></div>
                <div class="modal-body" id="mode-selection-buttons">
                    <button class="btn" data-mode="Learning">ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ù„Ù…</button>
                    <button class="btn" data-mode="MCQ">ğŸ”  Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</button>
                    <button class="btn" data-mode="Typing">âŒ¨ï¸ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
                    <button class="btn" data-mode="ListenType">ğŸ§ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ (MCQ)</button>
                    <button class="btn" data-mode="FillBlank">âœï¸ Ø§Ù…Ù„Ø£ Ø§Ù„ÙØ±Ø§Øº</button>
                    <button class="btn" data-mode="OrderWords">ğŸ“ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
                    <button class="btn" data-mode="Dictation">ğŸ¤ Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
                    <button class="btn btn-secondary" data-mode="Challenge">ğŸ² ØªØ­Ø¯ÙŠ Ù…ØªÙ†ÙˆØ¹</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sub-level-popover" class="hidden"></div>
    
    <div id="toast-container"></div>
    <audio id="success-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-success-505.mp3" preload="auto"></audio>
    <audio id="fail-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-223.mp3" preload="auto"></audio>
    <audio id="click-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-interface-click-1126.mp3" preload="auto"></audio>
    <audio id="tts-fallback-audio" preload="auto"></audio> 

    <script>
    (function() {
        "use strict";

        // --- 1. STATE & CONSTANTS ---
        const SUB_LEVEL_SIZE = 20;
        const UNLOCK_PERCENTAGE = 75;
        const app = {
            sentences: {}, userData: {}, settings: {},
            currentSession: null, pendingSession: {},
            isInitialized: false, ttsVoices: [],
            orderWordsUserSequence: [], 
            currentStreak: 0, 
        };
        const DOMElements = {
            splashScreen: document.getElementById('splash-screen'),
            mainMenuScreen: document.getElementById('main-menu-screen'),
            gameScreen: document.getElementById('game-screen'),
            genericScreen: {
                screen: document.getElementById('generic-screen'),
                title: document.getElementById('generic-title'),
                content: document.getElementById('generic-content'),
                backBtn: document.getElementById('generic-back-btn'),
            },
            levelContainer: document.getElementById('level-container'),
            toastContainer: document.getElementById('toast-container'),
            game: {
                sessionProgressBar: document.getElementById('session-progress-fill'),
                scoreDisplay: document.getElementById('score-display'),
                streakDisplay: document.getElementById('streak-display'),
                sentenceEn: document.getElementById('sentence-en'),
                sentenceAr: document.getElementById('sentence-ar'),
                typingInput: document.getElementById('typing-input'),
                mcqOptions: document.getElementById('mcq-options'),
                wordBlanks: document.getElementById('word-blanks'),
                wordBank: document.getElementById('word-bank'),
                checkBtn: document.getElementById('check-btn'),
                nextBtn: document.getElementById('next-btn'),
                hintBtn: document.getElementById('hint-btn'),
                mcqContainer: document.getElementById('mcq-container'),
                typingContainer: document.getElementById('typing-container'),
                listenContainer: document.getElementById('listen-container'),
                fillBlankContainer: document.getElementById('fill-blank-container'),
                orderWordsContainer: document.getElementById('order-words-container'),
                orderedSentenceArea: document.getElementById('ordered-sentence-area'),
                wordSelectionBank: document.getElementById('word-selection-bank'),
                dictationContainer: document.getElementById('dictation-container'),
                dictationWordDisplay: document.getElementById('dictation-word-display'),
            },
            modals: {
                summary: document.getElementById('summary-modal'),
                modeSelection: document.getElementById('mode-selection-modal'),
                modeSelectionButtons: document.getElementById('mode-selection-buttons'),
                popover: document.getElementById('sub-level-popover') // NEW: Popover element
            },
            audio: {
                success: document.getElementById('success-sound'),
                fail: document.getElementById('fail-sound'),
                click: document.getElementById('click-sound'),
                ttsFallback: document.getElementById('tts-fallback-audio'), 
            }
        };
        
        const ACHIEVEMENTS = {
            FIRST_CORRECT: { id: 'FIRST_CORRECT', name: 'Ø£ÙˆÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©', description: 'Ø£ÙˆÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©', icon: 'ğŸ¯' },
            A1_LEVEL_MASTER: { id: 'A1_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ A1', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ A1', icon: 'ğŸ“' },
            A2_LEVEL_MASTER: { id: 'A2_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ A2', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ A2', icon: 'ğŸŒŸ' },
            B1_LEVEL_MASTER: { id: 'B1_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ B1', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ B1', icon: 'ğŸ…' },
            B2_LEVEL_MASTER: { id: 'B2_LEVEL_MASTER', name: 'Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ B2', description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ B2', icon: 'ğŸ†' },
        };
        
        // --- 2. DATA MANAGEMENT ---
        const LS_KEYS = { USER_DATA: 'esj_userData_v11', SETTINGS: 'esj_settings_v11' }; 
        function getDefaultUserData() { 
            return { 
                unlockedSubLevels: { 'A1': ['1'] }, 
                stats: { totalScore: 0, totalMistakes: 0, completedLevels: [] }, 
                longestStreak: 0, 
                achievements: {}, 
                favorites: [] 
            }; 
        }
        function getDefaultSettings() { return { theme: 'light', soundEffects: true, ttsEnabled: true, ttsSpeed: 1.0, hapticsEnabled: true }; }
        function saveData() { localStorage.setItem(LS_KEYS.USER_DATA, JSON.stringify(app.userData)); }
        function saveSettings() { localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(app.settings)); }
        function loadData() {
            app.settings = { ...getDefaultSettings(), ...JSON.parse(localStorage.getItem(LS_KEYS.SETTINGS) || '{}') };
            app.userData = { ...getDefaultUserData(), ...JSON.parse(localStorage.getItem(LS_KEYS.USER_DATA) || '{}') };
        }

        // --- 3. CORE UTILITIES ---
        function playSound(type) {
            if (!app.settings.soundEffects) return;
            const sound = DOMElements.audio[type];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.error("Sound playback failed:", e));
            }
        }
        
        function flashScreen(type) {
            document.body.classList.add(`${type}-flash`);
            setTimeout(() => { document.body.classList.remove(`${type}-flash`); }, 300);
        }

        function speak(text) {
            if (!app.settings.ttsEnabled) return;
            
            const useWebSpeech = 'speechSynthesis' in window;
            
            if (useWebSpeech) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = app.settings.ttsSpeed;
                
                if (app.ttsVoices.length > 0) {
                     utterance.voice = app.ttsVoices.find(v => v.lang.startsWith('en')) || app.ttsVoices[0];
                }
                
                speechSynthesis.speak(utterance);
            } else {
                const encodedText = encodeURIComponent(text);
                const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=en&client=tw-ob`;
                
                const audio = DOMElements.audio.ttsFallback;
                
                audio.pause();
                audio.currentTime = 0;
                
                audio.src = ttsUrl;
                audio.play().catch(e => console.error("Fallback TTS playback failed:", e));
            }
        }

        function vibrate(d=50) { if(app.settings.hapticsEnabled && 'vibrate' in navigator) navigator.vibrate(d); }
        function showToast(message, type = 'info', icon = 'â„¹ï¸') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        let currentScreen = 'splash-screen';
        function showScreen(screenId) {
            // NEW: Hide popover when changing screens
            DOMElements.modals.popover.classList.add('hidden');
            
            document.getElementById(currentScreen)?.classList.add('hidden');
            document.getElementById(screenId)?.classList.remove('hidden');
            currentScreen = screenId;
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function cleanString(str) {
            return str.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
        }

        // --- 4. UI RENDERING ---
        function renderMainMenu() {
            const container = DOMElements.levelContainer;
            container.innerHTML = ''; 
            const mainLevels = Object.keys(app.sentences).sort();

            mainLevels.forEach(level => {
                const isLevelUnlocked = app.userData.unlockedSubLevels[level]?.length > 0;
                const levelCard = document.createElement('div');
                levelCard.className = `level-card ${isLevelUnlocked ? '' : 'locked'}`;
                
                const levelIcon = {{A1:'ğŸŒ±',A2:'ğŸ”µ',B1:'ğŸŸ ',B2:'ğŸŸ£'}[level]};
                const levelColor = `var(--${level.toLowerCase()}-color)`;
                
                levelCard.innerHTML = `
                    <div class="level-card-header">
                        <div class="level-icon" style="color: ${levelColor}">${levelIcon}</div>
                        <div class="level-name">${level}</div>
                    </div>
                    <div class="sub-level-container"></div>
                `;
                
                const subLevelContainer = levelCard.querySelector('.sub-level-container');
                
                Object.keys(app.sentences[level]).sort((a,b)=>+a - +b).forEach(key => {
                    const subLevelEl = document.createElement('div');
                    subLevelEl.className = 'sub-level';
                    subLevelEl.textContent = key;

                    if (app.userData.unlockedSubLevels[level].includes(key)) {
                        
                        // --- NEW: Change onclick to show Popover instead of Modal ---
                        subLevelEl.onclick = (e) => { 
                            e.stopPropagation(); // Prevent document click
                            playSound('click'); 
                            showModePopover(e.target, level, key); 
                        };
                        
                        // Check for completion status and apply styling
                        const levelKey = `${level}-${key}`;
                        if (app.userData.stats.completedLevels.includes(levelKey)) {
                            subLevelEl.classList.add('completed');
                        }

                    } else {
                        subLevelEl.classList.add('locked');
                    }
                    subLevelContainer.appendChild(subLevelEl);
                });
                
                container.appendChild(levelCard);
            });
            showScreen('main-menu-screen');
        }

        function renderQuestion() {
            if (app.currentSession.currentIndex >= app.currentSession.questions.length) return endSession();
            const sentence = app.currentSession.questions[app.currentSession.currentIndex];
            app.currentSession.currentSentence = sentence;

            DOMElements.gameScreen.dataset.sessionMode = app.currentSession.mode;
            DOMElements.game.sessionProgressBar.style.width = `${((app.currentSession.currentIndex + 1) / app.currentSession.questions.length) * 100}%`;
            
            // Reset question UI
            DOMElements.game.sentenceEn.textContent = '';
            DOMElements.game.sentenceAr.textContent = sentence.ar;
            DOMElements.game.typingInput.value = '';
            DOMElements.game.typingInput.disabled = false;
            DOMElements.game.typingInput.style.borderColor = 'var(--border-color)';
            
            ['mcq-container', 'typing-container', 'listen-container', 'fill-blank-container', 'order-words-container', 'dictation-container'].forEach(c => document.getElementById(c).classList.add('hidden'));
            DOMElements.game.nextBtn.classList.add('hidden');
            DOMElements.game.checkBtn.classList.remove('hidden');
            DOMElements.game.typingInput.style.textAlign = 'left'; 

            let mode = app.currentSession.mode;
            if (mode === 'Challenge') {
                const availableModes = ['MCQ', 'Typing', 'ListenType', 'FillBlank', 'OrderWords', 'Dictation'];
                mode = availableModes[Math.floor(Math.random() * availableModes.length)];
            }
            app.currentSession.currentModeForQuestion = mode;
            
            app.orderWordsUserSequence = [];

            switch (mode) {
                case 'Learning':
                    DOMElements.game.sentenceEn.textContent = sentence.en;
                    DOMElements.game.sentenceAr.textContent = sentence.ar;
                    DOMElements.game.typingContainer.classList.remove('hidden');
                    DOMElements.game.typingInput.placeholder = "Ø§ÙƒØªØ¨ Ù„Ù„Ù…Ù…Ø§Ø±Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)";
                    DOMElements.game.checkBtn.classList.add('hidden');
                    DOMElements.game.nextBtn.classList.remove('hidden');
                    speak(sentence.en);
                    break;
                case 'MCQ':
                case 'ListenType': 
                    DOMElements.game.mcqContainer.classList.remove('hidden');
                    DOMElements.game.mcqOptions.innerHTML = '';
                    
                    if (mode === 'ListenType') {
                        DOMElements.game.sentenceAr.textContent = ''; 
                        DOMElements.game.listenContainer.classList.remove('hidden');
                        speak(sentence.en); 
                    } else {
                        DOMElements.game.sentenceAr.textContent = sentence.ar; 
                    }

                    const allSentences = Object.values(app.sentences).flatMap(levels => Object.values(levels)).flat();
                    
                    const incorrectSentences = shuffleArray(allSentences.filter(s => cleanString(s.en) !== cleanString(sentence.en))).slice(0, 3);
                    const options = shuffleArray([sentence.en, ...incorrectSentences.map(s => s.en)]);
                    
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.textContent = opt;
                        // NEW: Added playSound('click') for better UX
                        btn.onclick = (e) => { playSound('click'); checkAnswer(opt, e.target); }; 
                        DOMElements.game.mcqOptions.appendChild(btn);
                    });
                    DOMElements.game.checkBtn.classList.add('hidden');
                    break;
                case 'Typing':
                    DOMElements.game.typingContainer.classList.remove('hidden');
                    DOMElements.game.typingInput.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©...";
                    DOMElements.game.sentenceAr.textContent = sentence.ar;
                    DOMElements.game.typingInput.focus();
                    break;
                case 'Dictation': 
                    DOMElements.game.dictationContainer.classList.remove('hidden');
                    DOMElements.game.typingContainer.classList.remove('hidden'); 
                    DOMElements.game.typingInput.style.textAlign = 'center'; 
                    DOMElements.game.sentenceAr.textContent = ''; 
                    
                    const words = sentence.en.match(/\b(\w+)\b/g) || [];
                    const selectedWord = words.length > 0 ? words[Math.floor(Math.random() * words.length)] : sentence.en.split(/\s+/).filter(w => w.trim() !== '')[0];
                    app.currentSession.correctDictationWord = cleanString(selectedWord);
                    
                    DOMElements.game.dictationWordDisplay.textContent = '...'; 
                    DOMElements.game.typingInput.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙŠ Ø³Ù…Ø¹ØªÙ‡Ø§...";
                    DOMElements.game.typingInput.focus();
                    
                    speak(selectedWord);
                    document.getElementById('replay-sound-btn').onclick = () => speak(selectedWord);
                    break;
                case 'FillBlank':
                    DOMElements.game.fillBlankContainer.classList.remove('hidden');
                    DOMElements.game.wordBlanks.innerHTML = '';
                    DOMElements.game.wordBank.innerHTML = '';
                    
                    const wordsFB = sentence.en.split(/\s+/).filter(w => w.trim() !== '');
                    const blankIndex = Math.floor(Math.random() * wordsFB.length);
                    const correctWordFB = wordsFB[blankIndex];
                    wordsFB[blankIndex] = `<span id="blank-placeholder" style="color:var(--text-secondary); font-weight: 700;">[.......]</span>`; // NEW: Better placeholder
                    DOMElements.game.wordBlanks.innerHTML = wordsFB.join(' ');
                    
                    const allWordsFB = new Set(Object.values(app.sentences).flatMap(levels => Object.values(levels)).flat().flatMap(s => s.en.match(/\b(\w+)\b/g) || [])); // NEW: Cleaner word split
                    const incorrectWordsFB = shuffleArray(Array.from(allWordsFB).filter(w => cleanString(w) !== cleanString(correctWordFB) && w.length > 2)).slice(0, 3);
                    const bankWordsFB = shuffleArray([correctWordFB, ...incorrectWordsFB]);
                    
                    bankWordsFB.forEach(word => {
                        const chip = document.createElement('div');
                        chip.className = 'word-chip';
                        chip.textContent = word;
                        // NEW: Added playSound('click') for better UX
                        chip.onclick = () => {
                            playSound('click');
                            checkAnswer(word, chip);
                        };
                        DOMElements.game.wordBank.appendChild(chip);
                    });
                    DOMElements.game.checkBtn.classList.add('hidden');
                    break;
                case 'OrderWords':
                    DOMElements.game.orderWordsContainer.classList.remove('hidden');
                    DOMElements.game.orderedSentenceArea.innerHTML = '';
                    DOMElements.game.wordSelectionBank.innerHTML = '';
                    
                    const wordsOW = sentence.en.match(/\b(\w+)\b|[^\w\s]/g) || []; // NEW: Better regex to include punctuation
                    const shuffledWordsOW = shuffleArray([...wordsOW]);

                    shuffledWordsOW.forEach((word, index) => {
                        const chip = document.createElement('div');
                        chip.className = 'word-to-select';
                        chip.textContent = word;
                        chip.dataset.index = index; 
                        chip.onclick = () => selectWord(chip, word);
                        DOMElements.game.wordSelectionBank.appendChild(chip);
                    });
                    DOMElements.game.checkBtn.classList.remove('hidden');
                    break;
            }
        }
        
        // ... (Functions selectWord, unselectWord, showSettings, showAboutSection, showStats, showAchievements) ...
        // [NOTE: These functions remain identical to the previous version to ensure logic continuity, 
        // with minor UI tweaks already included in the CSS.]

        function selectWord(chip, word) {
            playSound('click');
            chip.classList.add('disabled');
            chip.onclick = null;

            const orderedChip = document.createElement('div');
            orderedChip.className = 'ordered-word-chip';
            orderedChip.textContent = word;
            orderedChip.dataset.originalIndex = chip.dataset.index;
            orderedChip.onclick = () => unselectWord(orderedChip);

            DOMElements.game.orderedSentenceArea.appendChild(orderedChip);
            app.orderWordsUserSequence.push(word);
        }

        function unselectWord(orderedChip) {
            playSound('fail'); 
            const originalChip = DOMElements.game.wordSelectionBank.querySelector(`[data-index="${orderedChip.dataset.originalIndex}"]`);
            if (originalChip) {
                originalChip.classList.remove('disabled');
                originalChip.onclick = () => selectWord(originalChip, orderedChip.textContent);
            }

            const wordToRemove = orderedChip.textContent;
            // NEW: Remove the specific instance of the chip clicked
            app.orderWordsUserSequence = [];
            Array.from(DOMElements.game.orderedSentenceArea.children).forEach((chip, index) => {
                if (chip === orderedChip) {
                    // skip
                } else {
                    app.orderWordsUserSequence.push(chip.textContent);
                }
            });
            
            orderedChip.remove();
        }

        function showSettings() {
            DOMElements.genericScreen.title.textContent = "âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
            DOMElements.genericScreen.content.innerHTML = `
                <div class="setting-row"><span>Ø§Ù„Ù…Ø¸Ù‡Ø± (Ø¯Ø§ÙƒÙ†/ÙØ§ØªØ­)</span><input type="checkbox" id="theme-toggle"></div>
                <div class="setting-row"><span>ØªØ£Ø«ÙŠØ±Ø§Øª ØµÙˆØªÙŠØ©</span><input type="checkbox" id="sfx-toggle"></div>
                <div class="setting-row"><span>ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (TTS)</span><input type="checkbox" id="tts-toggle"></div>
                <div class="setting-row" id="about-btn-row"><span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª</span><button class="btn-icon">â„¹ï¸</button></div>
            `;
            document.getElementById('theme-toggle').checked = app.settings.theme === 'dark';
            document.getElementById('theme-toggle').onchange = e => {
                app.settings.theme = e.target.checked ? 'dark' : 'light';
                document.body.dataset.theme = app.settings.theme;
                saveSettings();
            };
            document.getElementById('sfx-toggle').checked = app.settings.soundEffects;
            document.getElementById('sfx-toggle').onchange = e => {
                app.settings.soundEffects = e.target.checked;
                saveSettings();
            };
            document.getElementById('tts-toggle').checked = app.settings.ttsEnabled;
            document.getElementById('tts-toggle').onchange = e => {
                app.settings.ttsEnabled = e.target.checked;
                saveSettings();
            };
            document.getElementById('about-btn-row').onclick = () => { playSound('click'); showAboutSection(); };
            
            showScreen('generic-screen');
        }

        function showAboutSection() {
             DOMElements.genericScreen.title.textContent = "â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚";
             DOMElements.genericScreen.content.innerHTML = `
                 <div class="about-section">
                     <h3>Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ø£Ø¯Ø§Ø©</h3>
                     <p>Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù‡ÙŠ Ø£Ø¯Ø§Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù…ØµÙ…Ù…Ø© Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¹Ù„Ù‰ Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (A1) Ø­ØªÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (B2) Ù…Ù† Ø®Ù„Ø§Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªÙ†ÙˆØ¹Ø© Ù…Ù† Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ù…ØªØ¹Ø© ÙˆØ§Ù„ÙØ¹Ø§Ù„Ø©ØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø©ØŒ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ØŒ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡ØŒ ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª.</p>
                 </div>
                 <div class="about-section">
                     <h3>ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</h3>
                     <ul>
                         <li><strong>ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ù„Ù…:</strong> Ø§Ø¨Ø¯Ø£ Ø¨Ù‡ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ù…Ù„Ø© ÙˆÙÙ‡Ù… Ù…Ø¹Ù†Ø§Ù‡Ø§ ÙˆÙ‡ÙŠÙƒÙ„Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ¯Ø±ÙŠØ¨.</li>
                         <li><strong>Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</strong> Ù…Ø«Ø§Ù„ÙŠ Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØ§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© ÙÙŠ Ø³ÙŠØ§Ù‚Ù‡Ø§.</li>
                         <li><strong>ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</strong> Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù…Ù„Ø© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Grammar) Ø¨Ø´ÙƒÙ„ Ø¹Ù…Ù„ÙŠ.</li>
                         <li><strong>Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ù…ØªÙ†ÙˆØ¹:</strong> Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†ÙØ³Ùƒ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.</li>
                     </ul>
                 </div>
                 <div class="about-section" style="justify-content: center; text-align: center;">
                    <p style="color: var(--text-primary);">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©.</p>
                    <p style="color: var(--accent); font-weight: bold;">Ù…Ù‚Ø¯Ù…Ø© Ù„ÙƒÙ… Ù…Ù†: Ù…Ø­Ù…ÙˆØ¯ Ø­Ø³Ù†</p>
                 </div>
             `;
             showScreen('generic-screen');
        }

        function showStats() {
            DOMElements.genericScreen.title.textContent = "ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª";
            DOMElements.genericScreen.content.innerHTML = `
                <div class="stat-item"><span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</span><span class="stat-value">${app.userData.stats.totalScore}</span></div>
                <div class="stat-item"><span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</span><span class="stat-value">${app.userData.stats.totalMistakes}</span></div>
                <div class="stat-item"><span class="stat-label">Ø£Ø·ÙˆÙ„ Ø­Ù…Ø§Ø³ (Streak)</span><span class="stat-value">ğŸ”¥${app.userData.longestStreak}</span></div>
            `;
            showScreen('generic-screen');
        }

        function showAchievements() {
            DOMElements.genericScreen.title.textContent = "ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª";
            DOMElements.genericScreen.content.innerHTML = '';
            
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                const isUnlocked = app.userData.achievements[achievement.id];
                const achEl = document.createElement('div');
                achEl.className = `achievement-item ${isUnlocked ? 'unlocked' : ''}`;
                achEl.innerHTML = `<div class="achievement-icon">${achievement.icon}</div><div><h3>${achievement.name}</h3><p>${achievement.description}</p></div>`;
                DOMElements.genericScreen.content.appendChild(achEl);
            });

            showScreen('generic-screen');
        }
        
        // ... (Functions checkAchievements, updateStreak, unlockNextSubLevel, endSession, checkAnswer) ...
        // [NOTE: These core logic functions remain identical to the previous version.]

        function updateStreak(isCorrect) {
            if (app.currentSession.mode === 'Learning') return;
            if (isCorrect) {
                app.currentStreak++;
                if (app.currentStreak > app.userData.longestStreak) {
                    app.userData.longestStreak = app.currentStreak;
                }
                DOMElements.game.streakDisplay.classList.add('active');
            } else {
                app.currentStreak = 0;
                DOMElements.game.streakDisplay.classList.remove('active');
            }
            DOMElements.game.streakDisplay.textContent = `ğŸ”¥${app.currentStreak}`;
        }
        
        function checkAchievements(isCorrect) {
            if (isCorrect && !app.userData.achievements.FIRST_CORRECT) {
                app.userData.achievements.FIRST_CORRECT = true;
                showToast('Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯: Ø£ÙˆÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! ğŸ‰', 'info', 'ğŸ¯');
            }
            
            const mainLevels = Object.keys(app.sentences).sort();
            mainLevels.forEach(level => {
                const allSubLevels = Object.keys(app.sentences[level]).map(Number);
                const completedSubLevels = allSubLevels.filter(sub => app.userData.stats.completedLevels.includes(`${level}-${sub}`));
                if (completedSubLevels.length === allSubLevels.length && !app.userData.achievements[`${level}_LEVEL_MASTER`]) {
                    app.userData.achievements[`${level}_LEVEL_MASTER`] = true;
                    showToast(`Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯: Ø®Ø¨ÙŠØ± Ù…Ø³ØªÙˆÙ‰ ${level}! ğŸ‰`, 'info', ACHIEVEMENTS[`${level}_LEVEL_MASTER`].icon);
                }
            });

            saveData();
        }

        // NEW: This function is no longer used, replaced by showModePopover
        function showModeSelectionModal(level, subLevel) {
            vibrate();
            playSound('click');
            app.pendingSession = { level, subLevel };
            DOMElements.modals.modeSelection.classList.remove('hidden');
        }
        
        // --- NEW: Popover Functions ---
        function showModePopover(targetElement, level, subLevel) {
            vibrate();
            app.pendingSession = { level, subLevel };
            const popover = DOMElements.modals.popover;

            // 1. Get content from existing modal (Reuse)
            const modeButtonsHTML = DOMElements.modals.modeSelectionButtons.innerHTML;
            popover.innerHTML = `<div id="popover-content">${modeButtonsHTML}</div>`;

            // 2. Position it
            const rect = targetElement.getBoundingClientRect();
            // 450px is an estimate, adjust if your button list is taller/shorter
            const popoverHeight = 450; 
            let popoverTop = window.scrollY + rect.bottom + 8; // Default: below

            // If it goes off-screen (bottom)
            if (popoverTop + popoverHeight > (window.innerHeight - 20)) { // 20px buffer
                popoverTop = window.scrollY + rect.top - popoverHeight - 8; // Position above
            }
            // If it goes off-screen (top)
            if (popoverTop < window.scrollY) {
                popoverTop = window.scrollY + rect.bottom + 8; // Default back to bottom
            }

            popover.style.top = `${popoverTop}px`;
            popover.style.left = `${window.scrollX + rect.left}px`;
            popover.style.width = `${targetElement.offsetWidth * 3}px`; // Base width on button
            popover.style.minWidth = '240px';

            // 3. Show it
            popover.classList.remove('hidden');

            // 4. Add click listeners to *new* popover buttons
            popover.querySelectorAll('[data-mode]').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation(); // Stop click from bubbling to document
                    startSession(btn.dataset.mode);
                    popover.classList.add('hidden'); // Hide on selection
                };
            });

            // 5. Add click-outside listener
            document.addEventListener('click', hidePopoverOnClickOutside, { once: true });
        }

        function hidePopoverOnClickOutside(event) {
            const popover = DOMElements.modals.popover;
            // Check if popover is visible and the click was outside it
            if (!popover.classList.contains('hidden') && !popover.contains(event.target)) {
                popover.classList.add('hidden');
            }
        }
        // --- END NEW ---

        function startSession(mode) {
            const { level, subLevel } = app.pendingSession;
            vibrate();
            playSound('click');
            
            const questions = shuffleArray([...app.sentences[level][subLevel]]);
            
            app.currentStreak = 0;
            
            app.currentSession = {
                level, subLevel, mode,
                questions,
                currentIndex: 0, score: 0, mistakes: [],
            };
            DOMElements.game.scoreDisplay.textContent = '0';
            DOMElements.game.streakDisplay.textContent = 'ğŸ”¥0';
            
            // NEW: Hide the popover, not the old modal
            DOMElements.modals.popover.classList.add('hidden'); 
            
            showScreen('game-screen');
            renderQuestion();
        }

        function unlockNextSubLevel() {
            const { level, subLevel } = app.currentSession;
            const subLevelNumber = parseInt(subLevel);
            const nextSubLevel = subLevelNumber + 1;
            const allSubLevels = Object.keys(app.sentences[level]).map(Number).sort((a,b) => a-b);
            const nextLevelExists = allSubLevels.includes(nextSubLevel);

            if (nextLevelExists) {
                if (!app.userData.unlockedSubLevels[level].includes(String(nextSubLevel))) {
                    app.userData.unlockedSubLevels[level].push(String(nextSubLevel));
                    showToast('ØªÙ… ÙØªØ­ Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯! ğŸ‰', 'success', 'ğŸ”“');
                }
            } else {
                const mainLevels = Object.keys(app.sentences);
                const currentLevelIndex = mainLevels.indexOf(level);
                if (currentLevelIndex < mainLevels.length - 1) {
                    const nextMainLevel = mainLevels[currentLevelIndex + 1];
                    if (!app.userData.unlockedSubLevels[nextMainLevel]) {
                        app.userData.unlockedSubLevels[nextMainLevel] = ['1'];
                        showToast(`ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… ÙØªØ­ Ù…Ø³ØªÙˆÙ‰ ${nextMainLevel}! ğŸ‰`, 'success', 'ğŸ”“');
                    }
                }
            }
            saveData();
        }

        function endSession() {
            const totalQuestions = app.currentSession.questions.length;
            const accuracy = (app.currentSession.score / totalQuestions) * 100;
            app.userData.stats.totalScore += app.currentSession.score;
            app.userData.stats.totalMistakes += (totalQuestions - app.currentSession.score);
            
            const levelKey = `${app.currentSession.level}-${app.currentSession.subLevel}`;
            if (accuracy >= UNLOCK_PERCENTAGE && !app.userData.stats.completedLevels.includes(levelKey)) {
                app.userData.stats.completedLevels.push(levelKey);
                unlockNextSubLevel();
            }

            DOMElements.modals.summary.classList.remove('hidden');
            document.getElementById('summary-score').textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${app.currentSession.score}`;
            document.getElementById('summary-accuracy').textContent = `Ø§Ù„Ø¯Ù‚Ø©: ${accuracy.toFixed(0)}%`;
            saveData();
            checkAchievements(true); 
        }

        function checkAnswer(userAnswer, targetElement) {
            if (app.currentSession.mode === 'Learning') return;
            const mode = app.currentSession.currentModeForQuestion;
            const correctEn = cleanString(app.currentSession.currentSentence.en);
            let isCorrect = false;
            let finalAnswer = userAnswer;

            if (mode === 'Dictation') {
                finalAnswer = DOMElements.game.typingInput.value;
                isCorrect = cleanString(finalAnswer) === app.currentSession.correctDictationWord;
            } else if (mode === 'Typing') {
                 finalAnswer = DOMElements.game.typingInput.value;
                 isCorrect = cleanString(finalAnswer) === correctEn;
            } else if (mode === 'FillBlank') {
                const originalWords = app.currentSession.currentSentence.en.match(/\b(\w+)\b|[^\w\s]/g) || []; // NEW: Better regex
                const correctWord = originalWords.find(w => cleanString(w) === cleanString(userAnswer));
                isCorrect = !!correctWord;
            } else if (mode === 'OrderWords') {
                const correctSentenceWords = app.currentSession.currentSentence.en.match(/\b(\w+)\b|[^\w\s]/g) || []; // NEW: Better regex
                finalAnswer = app.orderWordsUserSequence.join(' ');
                const correctSentence = correctSentenceWords.join(' ');
                isCorrect = cleanString(finalAnswer) === cleanString(correctSentence);
            } else {
                // MCQ, ListenType (MCQ)
                isCorrect = cleanString(userAnswer) === correctEn;
            }
            
            // --- Feedback and Scoring Logic ---
            
            updateStreak(isCorrect);

            if (isCorrect) {
                app.currentSession.score++;
                playSound('success');
                flashScreen('correct');
                showToast('Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! ğŸ‰', 'success', 'âœ…');
                vibrate([50, 50, 50]);
                
                if (mode !== 'Dictation') {
                    speak(app.currentSession.currentSentence.en);
                }
            } else {
                app.currentSession.mistakes.push({ ...app.currentSession.currentSentence, user_answer: finalAnswer });
                playSound('fail');
                flashScreen('incorrect');
                showToast('Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! ğŸ˜”', 'error', 'âŒ');
                vibrate(200);
            }

            DOMElements.game.scoreDisplay.textContent = `${app.currentSession.score}`;
            DOMElements.game.checkBtn.classList.add('hidden');
            DOMElements.game.nextBtn.classList.remove('hidden');
            DOMElements.game.sentenceEn.textContent = app.currentSession.currentSentence.en;

            // Mode-specific UI updates
            if (mode === 'Dictation') {
                 DOMElements.game.dictationWordDisplay.textContent = cleanString(app.currentSession.correctDictationWord);
                 DOMElements.game.dictationWordDisplay.style.color = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                 DOMElements.game.typingInput.disabled = true;
            } else if (mode === 'Typing') {
                DOMElements.game.typingInput.disabled = true;
                DOMElements.game.typingInput.style.borderColor = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
            } else if (mode === 'MCQ' || mode === 'ListenType') {
                document.querySelectorAll('#mcq-options .btn').forEach(btn => {
                    btn.disabled = true;
                    if (cleanString(btn.textContent) === correctEn) {
                        btn.classList.add('correct'); // This class needs to be defined in CSS
                        btn.style.backgroundColor = 'var(--success-color)'; // Fallback
                    } else if (targetElement === btn) {
                        btn.classList.add('incorrect'); // This class needs to be defined in CSS
                        btn.style.backgroundColor = 'var(--error-color)'; // Fallback
                    }
                });
            } else if (mode === 'FillBlank') {
                document.querySelectorAll('#word-bank .word-chip').forEach(chip => chip.style.pointerEvents = 'none');
                const placeholder = document.getElementById('blank-placeholder');
                if (placeholder) {
                    const correctWords = app.currentSession.currentSentence.en.split(/\s+/).filter(w => w.trim() !== '');
                    const blankWord = correctWords[DOMElements.game.wordBlanks.innerHTML.split(/\s+/).findIndex(w => w.includes('[.......]'))]; // NEW: Updated placeholder text
                    placeholder.textContent = blankWord;
                    placeholder.style.color = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                    if(isCorrect) {
                        targetElement.style.backgroundColor = 'var(--success-color)';
                        targetElement.style.color = 'white';
                    } else {
                         targetElement.style.backgroundColor = 'var(--error-color)';
                         targetElement.style.color = 'white';
                    }
                }
            } else if (mode === 'OrderWords') { 
                DOMElements.game.orderedSentenceArea.style.borderColor = isCorrect ? 'var(--success-color)' : 'var(--error-color)'; // NEW: Use border color
                document.querySelectorAll('#word-selection-bank .word-to-select').forEach(chip => chip.style.pointerEvents = 'none');
                document.querySelectorAll('#ordered-sentence-area .ordered-word-chip').forEach(chip => chip.onclick = null);

                // NEW: Show the correct sentence in chips
                DOMElements.game.orderedSentenceArea.innerHTML = '';
                const correctWordsFinal = app.currentSession.currentSentence.en.match(/\b(\w+)\b|[^\w\s]/g) || [];
                correctWordsFinal.forEach(word => {
                    const chip = document.createElement('div');
                    chip.className = 'ordered-word-chip';
                    chip.textContent = word;
                    chip.style.backgroundColor = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                    chip.style.color = 'white';
                    DOMElements.game.orderedSentenceArea.appendChild(chip);
                });
            }
            
            checkAchievements(isCorrect);
        }
        
        function useHint() {
            playSound('click'); // NEW: Add sound to hint
            const effectiveMode = app.currentSession.currentModeForQuestion;
            if (effectiveMode === 'Typing' || effectiveMode === 'ListenType') {
                const sentence = app.currentSession.currentSentence.en;
                const currentInput = DOMElements.game.typingInput.value;
                if (currentInput.length < sentence.length) {
                    DOMElements.game.typingInput.value = sentence.substring(0, currentInput.length + 1);
                }
            } else if (effectiveMode === 'OrderWords') {
                 const correctWords = app.currentSession.currentSentence.en.match(/\b(\w+)\b|[^\w\s]/g) || []; // NEW: Better regex
                 const nextCorrectWord = correctWords[app.orderWordsUserSequence.length];

                 if (nextCorrectWord) {
                    const chipToSelect = Array.from(DOMElements.game.wordSelectionBank.children).find(chip => 
                        !chip.classList.contains('disabled') && chip.textContent === nextCorrectWord
                    );
                    if (chipToSelect) {
                        selectWord(chipToSelect, nextCorrectWord);
                    }
                 }
            } else if (effectiveMode === 'Dictation') {
                const correctWord = cleanString(app.currentSession.correctDictationWord);
                const currentInput = DOMElements.game.typingInput.value;
                 if (currentInput.length < correctWord.length) {
                    DOMElements.game.typingInput.value = correctWord.substring(0, currentInput.length + 1);
                }
            }
        }

        // --- 6. EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('settings-btn').onclick = () => { playSound('click'); vibrate(); showSettings(); };
            document.getElementById('stats-btn').onclick = () => { playSound('click'); vibrate(); showStats(); };
            document.getElementById('achievements-btn').onclick = () => { playSound('click'); vibrate(); showAchievements(); };
            DOMElements.genericScreen.backBtn.onclick = () => { playSound('click'); vibrate(); renderMainMenu(); };

            // NEW: These listeners for the old modal are no longer necessary as the popover handles its own clicks.
            // document.querySelector('#mode-selection-modal .modal-overlay').onclick = () => { playSound('click'); DOMElements.modals.modeSelection.classList.add('hidden'); };
            // DOMElements.modals.modeSelectionButtons.addEventListener('click', e => {
            //     if (e.target.matches('[data-mode]')) startSession(e.target.dataset.mode);
            // });
            
            document.getElementById('back-to-menu-btn').onclick = () => { playSound('click'); renderMainMenu(); };
            DOMElements.game.checkBtn.onclick = () => {
                const mode = app.currentSession.currentModeForQuestion;
                if (mode === 'Typing' || mode === 'Dictation') {
                    checkAnswer(DOMElements.game.typingInput.value);
                } else if (mode === 'OrderWords') {
                    checkAnswer(app.orderWordsUserSequence.join(' '));
                }
            };
            DOMElements.game.nextBtn.onclick = () => { 
                if (DOMElements.audio.ttsFallback) {
                    DOMElements.audio.ttsFallback.pause();
                    DOMElements.audio.ttsFallback.currentTime = 0;
                }
                
                // Re-enable input for next question
                DOMElements.game.typingInput.disabled = false;
                DOMElements.game.typingInput.style.borderColor = 'var(--border-color)';

                playSound('click'); 
                app.currentSession.currentIndex++; 
                renderQuestion(); 
            };
            DOMElements.game.hintBtn.onclick = () => { useHint(); }; // Sound added in useHint()
            document.getElementById('replay-sound-btn').onclick = () => {
                 const mode = app.currentSession?.currentModeForQuestion;
                 if (mode === 'Dictation' && app.currentSession.correctDictationWord) {
                    speak(app.currentSession.correctDictationWord);
                 } else if (app.currentSession?.currentSentence?.en) {
                    speak(app.currentSession.currentSentence.en);
                 }
            };
            document.getElementById('summary-close-btn').onclick = () => { playSound('click'); DOMElements.modals.summary.classList.add('hidden'); renderMainMenu(); };

            DOMElements.game.typingInput.addEventListener('keydown', (e) => {
                const mode = app.currentSession?.currentModeForQuestion;
                if (e.key === 'Enter' && (mode === 'Typing' || mode === 'Dictation') && !DOMElements.game.checkBtn.classList.contains('hidden')) {
                    e.preventDefault();
                    DOMElements.game.checkBtn.click();
                }
            });
        }

        // --- 7. INITIALIZATION ---
        async function init() {
            if (app.isInitialized) return;
            app.isInitialized = true;
            loadData();
            document.body.dataset.theme = app.settings.theme;

            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => { app.ttsVoices = speechSynthesis.getVoices(); };
                app.ttsVoices = speechSynthesis.getVoices(); 
            }

            const levels = ['A1', 'A2', 'B1', 'B2'];
            const files = ['sentences1.json', 'sentences2.json', 'sentences3.json', 'sentences4.json']; 
            for(let i=0; i < files.length; i++) {
                try {
                    document.getElementById('loading-status').textContent = `Loading ${levels[i]}...`;
                    const response = await fetch(files[i]); 
                    if(!response.ok) throw new Error(`Failed to load`);
                    const data = await response.json();
                    const levelKey = levels[i];
                    app.sentences[levelKey] = {};
                    for (let j = 0; j < data.length; j += SUB_LEVEL_SIZE) {
                        const subLevelKey = (j / SUB_LEVEL_SIZE) + 1;
                        app.sentences[levelKey][subLevelKey] = data.slice(j, j + SUB_LEVEL_SIZE).map(s => ({...s, subLevel: `${subLevelKey}`}));
                    }
                } catch(e) { document.getElementById('loading-status').textContent = `Error loading data for ${levels[i]}. Using dummy data.`; 
                if(!app.sentences[levels[i]]) {
                    app.sentences[levels[i]] = {
                        '1': [{en: "I am happy", ar: "Ø£Ù†Ø§ Ø³Ø¹ÙŠØ¯"}, {en: "You are smart", ar: "Ø£Ù†Øª Ø°ÙƒÙŠ"}],
                        '2': [{en: "We need water", ar: "Ù†Ø­Ù† Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ù…Ø§Ø¡"}, {en: "She drinks coffee", ar: "Ù‡ÙŠ ØªØ´Ø±Ø¨ Ø§Ù„Ù‚Ù‡ÙˆØ©"}],
                    };
                }
                }
                document.getElementById('loading-progress').style.width = `${((i+1)/files.length) * 100}%`;
            }
            
            setupEventListeners();
            DOMElements.splashScreen.style.opacity = '0';
            setTimeout(() => { DOMElements.splashScreen.classList.add('hidden'); renderMainMenu(); }, 500);
        }
        
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>

