<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="English Sentences Journey - An interactive game to learn English sentences from A1 to B2 levels.">
    <title>English Sentences Journey | M.H.</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Poppins:wght@400;600&display=swap');

        :root {
            --font-ar: 'Cairo', sans-serif;
            --font-en: 'Poppins', sans-serif;
            
            /* Light Theme */
            --bg-light: #f4f7f9;
            --surface-light: #ffffff;
            --text-primary-light: #1a2533;
            --text-secondary-light: #5a6b7b;
            --accent-light: #007bff;
            --border-light: #e1e8ed;

            /* Dark Theme */
            --bg-dark: #121212;
            --surface-dark: #1e1e1e;
            --text-primary-dark: #e0e0e0;
            --text-secondary-dark: #a0a0a0;
            --accent-dark: #4dabf7;
            --border-dark: #333333;

            /* Level Colors */
            --a1-color: #4CAF50; /* Green */
            --a2-color: #2196F3; /* Blue */
            --b1-color: #FF9800; /* Orange */
            --b2-color: #9C27B0; /* Purple */

            /* Feedback Colors */
            --success-color: #28a745;
            --error-color: #dc3545;
            
            /* Apply theme */
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --accent: var(--accent-light);
            --border-color: var(--border-light);
        }
        
        body[data-theme="dark"] {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --accent: var(--accent-dark);
            --border-color: var(--border-dark);
        }
        
        /* Visual Feedback */
        body.correct-flash { animation: flashGreen 0.3s ease-in-out; }
        body.incorrect-flash { animation: flashRed 0.3s ease-in-out; }
        @keyframes flashGreen { from { background-color: var(--success-color); } to { background-color: var(--bg); } }
        @keyframes flashRed { from { background-color: var(--error-color); } to { background-color: var(--bg); } }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-ar), var(--font-en), sans-serif;
            background-color: var(--bg); color: var(--text-primary);
            line-height: 1.6; transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        #app { max-width: 800px; margin: 0 auto; padding: 1rem; min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .btn {
            display: inline-block; padding: 0.8rem 1.5rem; font-size: 1.1rem; font-weight: 600;
            border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease-in-out;
            background-color: var(--accent); color: white; text-decoration: none;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-secondary { background-color: var(--text-secondary); color: var(--bg); }
        .btn-icon { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-secondary); padding: 0.5rem; }
        .screen { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Splash Screen */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
        }
        #splash-title { font-size: 2.5rem; font-weight: 700; color: var(--accent); }
        #loading-bar { width: 80%; max-width: 300px; height: 5px; background: var(--border-color); border-radius: 5px; margin-top: 1rem; overflow: hidden; }
        #loading-progress { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s; }

        /* Main Menu Screen */
        #main-menu-screen header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        #main-title { font-size: 1.8rem; font-weight: 700; }
        #main-menu-controls { display: flex; gap: 0.5rem; }
        #level-container { display: flex; flex-direction: column; gap: 1.5rem; }
        .level-card { background-color: var(--surface); border-radius: 12px; padding: 1.5rem 1rem; border: 2px solid var(--border-color); }
        .level-card-header { display: flex; align-items: center; gap: 1rem; cursor: pointer; }
        .level-card.locked > .level-card-header { cursor: not-allowed; opacity: 0.6; }
        .level-icon { font-size: 2.5rem; }
        .level-name { font-size: 1.5rem; font-weight: bold; }
        .sub-level-container { display: none; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .level-card:not(.locked) .sub-level-container.visible { display: grid; }
        .sub-level {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--border-color);
            font-weight: bold; font-size: 1.2rem; cursor: pointer; position: relative;
            background-color: var(--surface); transition: transform 0.2s, box-shadow 0.2s;
        }
        .sub-level:hover { transform: scale(1.05); }
        .sub-level.locked { cursor: not-allowed; background-color: var(--border-color); color: var(--text-secondary); }
        .sub-level.completed { border-color: var(--success-color); color: var(--success-color); }
        .sub-level .progress-ring { position: absolute; top: -5px; left: -5px; width: 74px; height: 74px; }
        .sub-level .progress-ring-circle { transition: stroke-dashoffset 0.3s; transform: rotate(-90deg); transform-origin: 50% 50%; }

        /* Game Screen */
        #game-screen header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        #session-progress-bar { flex-grow: 1; height: 10px; background: var(--border-color); border-radius: 5px; }
        #session-progress-fill { width: 0%; height: 100%; background: var(--accent); border-radius: 5px; transition: width 0.3s; }
        #score-display, #streak-display { font-weight: bold; font-size: 1.1rem; }
        #game-screen[data-session-mode="Learning"] #score-display,
        #game-screen[data-session-mode="Learning"] #streak-display { display: none; }
        #streak-display.active { color: #ff9800; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { to { transform: scale(1.1); } }
        #sentence-container { background: var(--surface); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; min-height: 150px; display: flex; flex-direction: column; justify-content: center; }
        #sentence-en { font-family: var(--font-en); font-size: 1.4rem; font-weight: 600; margin-bottom: 0.5rem; text-align: left; }
        #sentence-ar { font-family: var(--font-ar); font-size: 1.2rem; color: var(--text-secondary); }
        
        /* Game Modes */
        #mcq-options { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        @media (min-width: 600px) { #mcq-options { grid-template-columns: 1fr 1fr; } }
        #mcq-options .btn { width: 100%; background-color: var(--surface); color: var(--text-primary); border: 2px solid var(--border-color); }
        #mcq-options .btn:hover { background-color: var(--border-color); }
        #mcq-options .btn.correct { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        #mcq-options .btn.incorrect { background-color: var(--error-color); color: white; border-color: var(--error-color); }
        #fill-blank-container { text-align: center; }
        #word-blanks { font-size: 1.4rem; font-weight: 600; padding: 1rem; min-height: 50px; }
        #word-bank { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1rem; }
        #word-bank .word-chip { padding: 0.5rem 1rem; background: var(--surface); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; }
        #typing-input { width: 100%; padding: 1rem; font-size: 1.2rem; border-radius: 8px; border: 2px solid var(--border-color); background: var(--bg); color: var(--text-primary); text-align: left; }
        #listen-container { text-align: center; }
        #game-controls { display: flex; justify-content: space-between; align-items: center; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 500; }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--surface); border-radius: 12px; padding: 2rem;
            width: 90%; max-width: 500px; z-index: 501; animation: popIn 0.3s;
        }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.5rem; font-weight: bold; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; }
        
        #mode-selection-modal .modal-body { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 600px) { #mode-selection-modal .modal-body { grid-template-columns: 1fr 1fr; } }
        #mode-selection-modal .btn { width: 100%; text-align: center; }

        /* Generic Screens (Settings, Stats, Achievements) */
        .setting-row, .stat-item, .achievement-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; background-color: var(--surface);
            border-radius: 8px; margin-bottom: 1rem;
        }
        .achievement-item { opacity: 0.5; }
        .achievement-item.unlocked { opacity: 1; }
        .achievement-icon { font-size: 2.5rem; }
        
        /* New Styles */
        .stat-label { font-size: 1.1rem; font-weight: bold; }
        .stat-value { font-size: 1.1rem; color: var(--text-secondary); }

        /* Toast Notifications */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 1rem 2rem; border-radius: 8px; color: white; z-index: 1001;
            display: flex; align-items: center; gap: 0.75rem;
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }
        .toast.info { background-color: var(--accent); }
        @keyframes toastIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes toastOut { to { opacity: 0; bottom: 0; } }
    </style>
</head>
<body data-theme="light">

    <div id="app">
        <div id="splash-screen"><h1 id="splash-title">English Sentences Journey</h1><div id="loading-bar"><div id="loading-progress"></div></div><p id="loading-status"></p></div>
        <div id="main-menu-screen" class="screen hidden"><header><h1 id="main-title">رحلة الجمل الإنجليزية</h1><div id="main-menu-controls"><button id="achievements-btn" class="btn-icon" title="Achievements">🏆</button><button id="stats-btn" class="btn-icon" title="Statistics">📊</button><button id="settings-btn" class="btn-icon" title="Settings">⚙️</button></div></header><main><h2 style="margin-bottom: 1rem;">اختر المستوى</h2><div id="level-container"></div></main></div>
        <div id="game-screen" class="screen hidden"><header><button id="back-to-menu-btn" class="btn-icon">↩️</button><div id="session-progress-bar"><div id="session-progress-fill"></div></div><div id="score-display">0</div><div id="streak-display">🔥0</div></header><main><div id="sentence-container"><p id="sentence-en"></p><p id="sentence-ar"></p></div><div id="game-mode-container"><div id="mcq-container" class="hidden"><div id="mcq-options"></div></div><div id="typing-container" class="hidden"><input type="text" id="typing-input" placeholder="اكتب الجملة الإنجليزية..."></div><div id="listen-container" class="hidden"><button id="play-sound-btn" class="btn btn-icon" style="font-size: 3rem;">🔊</button></div><div id="fill-blank-container" class="hidden"><div id="word-blanks"></div><div id="word-bank"></div></div></div><div id="game-controls"><div id="game-controls-left"><button id="hint-btn" class="btn btn-secondary">تلميح</button><button id="fav-btn" class="btn-icon">🤍</button><button id="replay-sound-btn" class="btn-icon">🔊</button></div><button id="check-btn" class="btn">تحقق</button><button id="next-btn" class="btn hidden">التالي</button></div></main></div>
        <div id="generic-screen" class="screen hidden" style="animation: slideIn 0.4s;"><header><button id="generic-back-btn" class="btn-icon">↩️</button><h2 id="generic-title"></h2></header><main id="generic-content"></main></div>

        <div id="summary-modal" class="hidden"><div class="modal-overlay"></div><div class="modal"><div class="modal-header"><h2 class="modal-title">ملخص الجلسة</h2></div><div class="modal-body"><p id="summary-score"></p><p id="summary-accuracy"></p></div><div class="modal-footer"><button id="review-mistakes-btn" class="btn btn-secondary">راجع أخطائي</button><button id="summary-close-btn" class="btn">إغلاق</button></div></div></div>
        <div id="mode-selection-modal" class="hidden">
            <div class="modal-overlay"></div>
            <div class="modal">
                <div class="modal-header"><h2 class="modal-title">اختر وضع اللعب</h2></div>
                <div class="modal-body" id="mode-selection-buttons">
                    <button class="btn" data-mode="Learning">🎓 وضع التعلم</button>
                    <button class="btn" data-mode="MCQ">🔠 اختيار من متعدد</button>
                    <button class="btn" data-mode="Typing">⌨️ تدريب الكتابة</button>
                    <button class="btn" data-mode="ListenType">🎧 تدريب الاستماع</button>
                    <button class="btn" data-mode="FillBlank">✍️ املأ الفراغ</button>
                    <button class="btn btn-secondary" data-mode="Challenge">🎲 تحدي متنوع</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>
    <audio id="success-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-success-505.mp3" preload="auto"></audio>
    <audio id="fail-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-223.mp3" preload="auto"></audio>
    <audio id="click-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-interface-click-1126.mp3" preload="auto"></audio>

    <script>
    (function() {
        "use strict";

        // --- 1. STATE & CONSTANTS ---
        const SUB_LEVEL_SIZE = 20;
        const UNLOCK_PERCENTAGE = 75;
        const QUIZ_LEVEL_INTERVAL = 20;
        const app = {
            sentences: {}, userData: {}, settings: {},
            currentSession: null, pendingSession: {},
            isInitialized: false, ttsVoices: [],
        };
        const DOMElements = {
            splashScreen: document.getElementById('splash-screen'),
            mainMenuScreen: document.getElementById('main-menu-screen'),
            gameScreen: document.getElementById('game-screen'),
            genericScreen: {
                screen: document.getElementById('generic-screen'),
                title: document.getElementById('generic-title'),
                content: document.getElementById('generic-content'),
                backBtn: document.getElementById('generic-back-btn'),
            },
            levelContainer: document.getElementById('level-container'),
            toastContainer: document.getElementById('toast-container'),
            game: {
                sessionProgressBar: document.getElementById('session-progress-fill'),
                scoreDisplay: document.getElementById('score-display'),
                streakDisplay: document.getElementById('streak-display'),
                sentenceEn: document.getElementById('sentence-en'),
                sentenceAr: document.getElementById('sentence-ar'),
                typingInput: document.getElementById('typing-input'),
                mcqOptions: document.getElementById('mcq-options'),
                wordBlanks: document.getElementById('word-blanks'),
                wordBank: document.getElementById('word-bank'),
                checkBtn: document.getElementById('check-btn'),
                nextBtn: document.getElementById('next-btn'),
                hintBtn: document.getElementById('hint-btn'),
                mcqContainer: document.getElementById('mcq-container'),
                typingContainer: document.getElementById('typing-container'),
                listenContainer: document.getElementById('listen-container'),
                fillBlankContainer: document.getElementById('fill-blank-container'),
            },
            modals: {
                summary: document.getElementById('summary-modal'),
                modeSelection: document.getElementById('mode-selection-modal'),
                modeSelectionButtons: document.getElementById('mode-selection-buttons'),
            },
            audio: {
                success: document.getElementById('success-sound'),
                fail: document.getElementById('fail-sound'),
                click: document.getElementById('click-sound'),
            }
        };
        
        const ACHIEVEMENTS = {
            FIRST_CORRECT: { id: 'FIRST_CORRECT', name: 'أول إجابة صحيحة', description: 'أول إجابة صحيحة', icon: '🎯' },
            FIRST_QUIZ_COMPLETION: { id: 'FIRST_QUIZ_COMPLETION', name: 'أول اختبار', description: 'إكمال أول اختبار', icon: '📝' },
            A1_LEVEL_MASTER: { id: 'A1_LEVEL_MASTER', name: 'خبير مستوى A1', description: 'أكمل جميع المستويات الفرعية في A1', icon: '🎓' },
            A2_LEVEL_MASTER: { id: 'A2_LEVEL_MASTER', name: 'خبير مستوى A2', description: 'أكمل جميع المستويات الفرعية في A2', icon: '🌟' },
            B1_LEVEL_MASTER: { id: 'B1_LEVEL_MASTER', name: 'خبير مستوى B1', description: 'أكمل جميع المستويات الفرعية في B1', icon: '🏅' },
            B2_LEVEL_MASTER: { id: 'B2_LEVEL_MASTER', name: 'خبير مستوى B2', description: 'أكمل جميع المستويات الفرعية في B2', icon: '🏆' },
        };
        
        // --- 2. DATA MANAGEMENT ---
        const LS_KEYS = { USER_DATA: 'esj_userData_v7', SETTINGS: 'esj_settings_v7' };
        function getDefaultUserData() { 
            return { 
                unlockedSubLevels: { 'A1': ['1'] }, 
                stats: { totalScore: 0, totalMistakes: 0, completedLevels: [] }, 
                longestStreak: 0, 
                achievements: {}, 
                favorites: [] 
            }; 
        }
        function getDefaultSettings() { return { theme: 'light', soundEffects: true, ttsEnabled: true, ttsSpeed: 1.0, hapticsEnabled: true }; }
        function saveData() { localStorage.setItem(LS_KEYS.USER_DATA, JSON.stringify(app.userData)); }
        function saveSettings() { localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(app.settings)); }
        function loadData() {
            app.settings = { ...getDefaultSettings(), ...JSON.parse(localStorage.getItem(LS_KEYS.SETTINGS) || '{}') };
            app.userData = { ...getDefaultUserData(), ...JSON.parse(localStorage.getItem(LS_KEYS.USER_DATA) || '{}') };
        }

        // --- 3. CORE UTILITIES ---
        function playSound(type) {
            if (!app.settings.soundEffects) return;
            const sound = DOMElements.audio[type];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.error("Sound playback failed:", e));
            }
        }
        
        function flashScreen(type) {
            document.body.classList.add(`${type}-flash`);
            setTimeout(() => { document.body.classList.remove(`${type}-flash`); }, 300);
        }

        function speak(text) {
            if (!app.settings.ttsEnabled || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = app.settings.ttsSpeed;
            if (app.ttsVoices.length > 0) {
                 utterance.voice = app.ttsVoices.find(v => v.lang.startsWith('en')) || app.ttsVoices[0];
            }
            speechSynthesis.speak(utterance);
        }

        function vibrate(d=50) { if(app.settings.hapticsEnabled && 'vibrate' in navigator) navigator.vibrate(d); }
        function showToast(message, type = 'info', icon = 'ℹ️') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        let currentScreen = 'splash-screen';
        function showScreen(screenId) {
            document.getElementById(currentScreen)?.classList.add('hidden');
            document.getElementById(screenId)?.classList.remove('hidden');
            currentScreen = screenId;
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function cleanString(str) {
            return str.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
        }

        // --- 4. UI RENDERING ---
        function renderMainMenu() {
            const container = DOMElements.levelContainer;
            container.innerHTML = ''; 
            const mainLevels = Object.keys(app.sentences).sort();

            mainLevels.forEach(level => {
                const isLevelUnlocked = app.userData.unlockedSubLevels[level]?.length > 0;
                const levelCard = document.createElement('div');
                levelCard.className = `level-card ${isLevelUnlocked ? '' : 'locked'}`;
                levelCard.innerHTML = `<div class="level-card-header"><div class="level-icon" style="color: var(--${level.toLowerCase()}-color)">${{A1:'🌱',A2:'🔵',B1:'🟠',B2:'🟣'}[level]}</div><div class="level-name">${level}</div></div><div class="sub-level-container"></div>`;
                
                if (isLevelUnlocked) {
                    const subLevelContainer = levelCard.querySelector('.sub-level-container');
                    Object.keys(app.sentences[level]).sort((a,b)=>+a - +b).forEach(key => {
                        const subLevelEl = document.createElement('div');
                        subLevelEl.className = 'sub-level';
                        subLevelEl.textContent = key;
                        if (app.userData.unlockedSubLevels[level].includes(key)) {
                            subLevelEl.onclick = () => { playSound('click'); showModeSelectionModal(level, key); };
                        } else {
                            subLevelEl.classList.add('locked');
                        }
                        subLevelContainer.appendChild(subLevelEl);
                    });
                    levelCard.querySelector('.level-card-header').onclick = () => { playSound('click'); subLevelContainer.classList.toggle('visible'); };
                    if (level === mainLevels.filter(l => app.userData.unlockedSubLevels[l]).pop()) {
                        subLevelContainer.classList.add('visible');
                    }
                }
                container.appendChild(levelCard);
            });
            showScreen('main-menu-screen');
        }

        function renderQuestion() {
            if (app.currentSession.currentIndex >= app.currentSession.questions.length) return endSession();
            const sentence = app.currentSession.questions[app.currentSession.currentIndex];
            app.currentSession.currentSentence = sentence;

            DOMElements.gameScreen.dataset.sessionMode = app.currentSession.mode;
            DOMElements.game.sessionProgressBar.style.width = `${((app.currentSession.currentIndex + 1) / app.currentSession.questions.length) * 100}%`;
            DOMElements.game.sentenceEn.textContent = '';
            DOMElements.game.sentenceAr.textContent = sentence.ar;
            
            ['mcq-container', 'typing-container', 'listen-container', 'fill-blank-container'].forEach(c => document.getElementById(c).classList.add('hidden'));
            DOMElements.game.nextBtn.classList.add('hidden');
            DOMElements.game.checkBtn.classList.remove('hidden');

            let mode = app.currentSession.mode;
            if (mode === 'Challenge') {
                const availableModes = ['MCQ', 'Typing', 'ListenType', 'FillBlank'];
                mode = availableModes[Math.floor(Math.random() * availableModes.length)];
            }
            app.currentSession.currentModeForQuestion = mode;
            
            DOMElements.game.typingInput.value = '';

            switch (mode) {
                case 'Learning':
                    DOMElements.game.sentenceEn.textContent = sentence.en;
                    DOMElements.game.sentenceAr.textContent = sentence.ar;
                    DOMElements.game.typingContainer.classList.remove('hidden');
                    DOMElements.game.typingInput.placeholder = "اكتب للممارسة (اختياري)";
                    DOMElements.game.checkBtn.classList.add('hidden');
                    DOMElements.game.nextBtn.classList.remove('hidden');
                    speak(sentence.en);
                    break;
                case 'MCQ':
                    DOMElements.game.mcqContainer.classList.remove('hidden');
                    DOMElements.game.mcqOptions.innerHTML = '';
                    const allSentences = Object.values(app.sentences).flatMap(levels => Object.values(levels)).flat();
                    
                    const incorrectSentences = shuffleArray(allSentences.filter(s => cleanString(s.en) !== cleanString(sentence.en))).slice(0, 3);
                    const options = shuffleArray([sentence.en, ...incorrectSentences.map(s => s.en)]);
                    
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.textContent = opt;
                        btn.onclick = () => checkAnswer(opt);
                        DOMElements.game.mcqOptions.appendChild(btn);
                    });
                    break;
                case 'Typing':
                case 'ListenType':
                    DOMElements.game.typingContainer.classList.remove('hidden');
                    DOMElements.game.typingInput.placeholder = mode === 'Typing' ? "اكتب الجملة الإنجليزية..." : "اكتب ما تسمعه...";
                    DOMElements.game.sentenceAr.textContent = mode === 'Typing' ? sentence.ar : '';
                    if (mode === 'ListenType') {
                        DOMElements.game.listenContainer.classList.remove('hidden');
                        speak(sentence.en);
                    }
                    DOMElements.game.typingInput.focus();
                    break;
                case 'FillBlank':
                    DOMElements.game.fillBlankContainer.classList.remove('hidden');
                    DOMElements.game.wordBlanks.innerHTML = '';
                    DOMElements.game.wordBank.innerHTML = '';
                    
                    const words = sentence.en.split(/\s+/).filter(w => w.trim() !== '');
                    const blankIndex = Math.floor(Math.random() * words.length);
                    const correctWord = words[blankIndex];
                    words[blankIndex] = `<span id="blank-placeholder" style="color:var(--text-secondary)">[....]</span>`;
                    DOMElements.game.wordBlanks.innerHTML = words.join(' ');
                    
                    const allWords = new Set(Object.values(app.sentences).flatMap(levels => Object.values(levels)).flat().flatMap(s => s.en.split(/\s+/)));
                    const incorrectWords = shuffleArray(Array.from(allWords).filter(w => cleanString(w) !== cleanString(correctWord))).slice(0, 3);
                    const bankWords = shuffleArray([correctWord, ...incorrectWords]);
                    
                    bankWords.forEach(word => {
                        const chip = document.createElement('div');
                        chip.className = 'word-chip';
                        chip.textContent = word;
                        chip.onclick = () => {
                            checkAnswer(word);
                        };
                        DOMElements.game.wordBank.appendChild(chip);
                    });
                    DOMElements.game.checkBtn.classList.add('hidden');
                    break;
            }
        }
        
        function showSettings() {
            DOMElements.genericScreen.title.textContent = "الإعدادات";
            DOMElements.genericScreen.content.innerHTML = `
                <div class="setting-row"><span>المظهر (داكن/فاتح)</span><input type="checkbox" id="theme-toggle"></div>
                <div class="setting-row"><span>تأثيرات صوتية</span><input type="checkbox" id="sfx-toggle"></div>
            `;
            document.getElementById('theme-toggle').checked = app.settings.theme === 'dark';
            document.getElementById('theme-toggle').onchange = e => {
                app.settings.theme = e.target.checked ? 'dark' : 'light';
                document.body.dataset.theme = app.settings.theme;
                saveSettings();
            };
            document.getElementById('sfx-toggle').checked = app.settings.soundEffects;
            document.getElementById('sfx-toggle').onchange = e => {
                app.settings.soundEffects = e.target.checked;
                saveSettings();
            };
            showScreen('generic-screen');
        }

        function showStats() {
            DOMElements.genericScreen.title.textContent = "الإحصائيات";
            DOMElements.genericScreen.content.innerHTML = `
                <div class="stat-item"><span class="stat-label">إجمالي النقاط</span><span class="stat-value">${app.userData.stats.totalScore}</span></div>
                <div class="stat-item"><span class="stat-label">إجمالي الأخطاء</span><span class="stat-value">${app.userData.stats.totalMistakes}</span></div>
            `;
            showScreen('generic-screen');
        }

        function showAchievements() {
            DOMElements.genericScreen.title.textContent = "الإنجازات";
            DOMElements.genericScreen.content.innerHTML = '';
            
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                const isUnlocked = app.userData.achievements[achievement.id];
                const achEl = document.createElement('div');
                achEl.className = `achievement-item ${isUnlocked ? 'unlocked' : ''}`;
                achEl.innerHTML = `<div class="achievement-icon">${achievement.icon}</div><div><h3>${achievement.name}</h3><p>${achievement.description}</p></div>`;
                DOMElements.genericScreen.content.appendChild(achEl);
            });

            showScreen('generic-screen');
        }

        // --- 5. GAME LOGIC ---
        function checkAchievements(isCorrect) {
            if (isCorrect && !app.userData.achievements.FIRST_CORRECT) {
                app.userData.achievements.FIRST_CORRECT = true;
                showToast('إنجاز جديد: أول إجابة صحيحة! 🎉', 'info', '🎯');
            }
            if (app.currentSession.mode === 'Quiz' && app.currentSession.currentIndex >= app.currentSession.questions.length -1 && !app.userData.achievements.FIRST_QUIZ_COMPLETION) {
                app.userData.achievements.FIRST_QUIZ_COMPLETION = true;
                showToast('إنجاز جديد: أول اختبار! 📝', 'info', '📝');
            }
            
            const mainLevels = Object.keys(app.sentences).sort();
            mainLevels.forEach(level => {
                const allSubLevels = Object.keys(app.sentences[level]).map(Number);
                const completedSubLevels = allSubLevels.filter(sub => app.userData.stats.completedLevels.includes(`${level}-${sub}`));
                if (completedSubLevels.length === allSubLevels.length && !app.userData.achievements[`${level}_LEVEL_MASTER`]) {
                    app.userData.achievements[`${level}_LEVEL_MASTER`] = true;
                    showToast(`إنجاز جديد: خبير مستوى ${level}! 🎉`, 'info', ACHIEVEMENTS[`${level}_LEVEL_MASTER`].icon);
                }
            });

            saveData();
        }

        function showModeSelectionModal(level, subLevel) {
            vibrate();
            playSound('click');
            app.pendingSession = { level, subLevel };
            DOMElements.modals.modeSelection.classList.remove('hidden');

            const quizButton = DOMElements.modals.modeSelectionButtons.querySelector('[data-mode="Quiz"]');
            if (quizButton) quizButton.remove();

            const subLevelNumber = parseInt(subLevel);
            const allSubLevelsInLevel = Object.keys(app.sentences[level]).length;
            
            if (subLevelNumber > 0 && subLevelNumber % QUIZ_LEVEL_INTERVAL === 0 || subLevelNumber === allSubLevelsInLevel) {
                const newQuizBtn = document.createElement('button');
                newQuizBtn.className = 'btn';
                newQuizBtn.dataset.mode = 'Quiz';
                newQuizBtn.textContent = '📝 اختبار شامل';
                DOMElements.modals.modeSelectionButtons.appendChild(newQuizBtn);
            }
        }

        function startSession(mode) {
            const { level, subLevel } = app.pendingSession;
            vibrate();
            playSound('click');
            let questions;
            if (mode === 'Quiz') {
                 const allSentencesInLevel = Object.values(app.sentences[level]).flat();
                 questions = shuffleArray(allSentencesInLevel).slice(0, 10);
            } else {
                questions = shuffleArray([...app.sentences[level][subLevel]]);
            }
            
            app.currentSession = {
                level, subLevel, mode,
                questions,
                currentIndex: 0, score: 0, mistakes: [],
            };
            DOMElements.game.scoreDisplay.textContent = '0';
            DOMElements.game.streakDisplay.textContent = '🔥0';
            DOMElements.modals.modeSelection.classList.add('hidden');
            showScreen('game-screen');
            renderQuestion();
        }

        function unlockNextSubLevel() {
            const { level, subLevel } = app.currentSession;
            const subLevelNumber = parseInt(subLevel);
            const nextSubLevel = subLevelNumber + 1;
            const allSubLevels = Object.keys(app.sentences[level]).map(Number).sort((a,b) => a-b);
            const nextLevelExists = allSubLevels.includes(nextSubLevel);

            if (nextLevelExists) {
                if (!app.userData.unlockedSubLevels[level].includes(String(nextSubLevel))) {
                    app.userData.unlockedSubLevels[level].push(String(nextSubLevel));
                    showToast('تم فتح مستوى جديد! 🎉', 'success', '🔓');
                }
            } else {
                const mainLevels = Object.keys(app.sentences);
                const currentLevelIndex = mainLevels.indexOf(level);
                if (currentLevelIndex < mainLevels.length - 1) {
                    const nextMainLevel = mainLevels[currentLevelIndex + 1];
                    if (!app.userData.unlockedSubLevels[nextMainLevel]) {
                        app.userData.unlockedSubLevels[nextMainLevel] = ['1'];
                        showToast(`تهانينا! تم فتح مستوى ${nextMainLevel}! 🎉`, 'success', '🔓');
                    }
                }
            }
            saveData();
        }

        function endSession() {
            const accuracy = (app.currentSession.score / app.currentSession.questions.length) * 100;
            app.userData.stats.totalScore += app.currentSession.score;
            app.userData.stats.totalMistakes += (app.currentSession.questions.length - app.currentSession.score);
            if (accuracy >= UNLOCK_PERCENTAGE && app.currentSession.mode !== 'Quiz') {
                const levelKey = `${app.currentSession.level}-${app.currentSession.subLevel}`;
                if(!app.userData.stats.completedLevels.includes(levelKey)) {
                     app.userData.stats.completedLevels.push(levelKey);
                }
                unlockNextSubLevel();
            }

            DOMElements.modals.summary.classList.remove('hidden');
            document.getElementById('summary-score').textContent = `النقاط: ${app.currentSession.score}`;
            document.getElementById('summary-accuracy').textContent = `الدقة: ${accuracy.toFixed(0)}%`;
            saveData();
            checkAchievements(true); // Check for level master achievements
        }

        function checkAnswer(userAnswer) {
            if (app.currentSession.mode === 'Learning') return;
            const correctEn = cleanString(app.currentSession.currentSentence.en);
            let isCorrect = false;

            if (app.currentSession.currentModeForQuestion === 'FillBlank') {
                const originalWords = app.currentSession.currentSentence.en.split(/\s+/).filter(w => w.trim() !== '');
                const correctWord = originalWords.find(w => cleanString(w) === cleanString(userAnswer));
                isCorrect = !!correctWord;
            } else {
                isCorrect = cleanString(userAnswer) === correctEn;
            }

            if (isCorrect) {
                app.currentSession.score++;
                playSound('success');
                flashScreen('correct');
                showToast('إجابة صحيحة! 🎉', 'success', '✅');
                vibrate([50, 50, 50]);
            } else {
                app.currentSession.mistakes.push({ ...app.currentSession.currentSentence, user_answer: userAnswer });
                playSound('fail');
                flashScreen('incorrect');
                showToast('إجابة خاطئة! 😔', 'error', '❌');
                vibrate(200);
            }
            
            checkAchievements(isCorrect);

            DOMElements.game.scoreDisplay.textContent = `${app.currentSession.score}`;
            DOMElements.game.checkBtn.classList.add('hidden');
            DOMElements.game.nextBtn.classList.remove('hidden');
            DOMElements.game.sentenceEn.textContent = app.currentSession.currentSentence.en;
            
            if (app.currentSession.currentModeForQuestion === 'MCQ') {
                document.querySelectorAll('#mcq-options .btn').forEach(btn => {
                    btn.disabled = true;
                    if (cleanString(btn.textContent) === correctEn) {
                        btn.classList.add('correct');
                    } else if (cleanString(userAnswer) === cleanString(btn.textContent)) {
                        btn.classList.add('incorrect');
                    }
                });
            } else if (app.currentSession.currentModeForQuestion === 'FillBlank') {
                document.querySelectorAll('#word-bank .word-chip').forEach(chip => chip.style.pointerEvents = 'none');
                const placeholder = document.getElementById('blank-placeholder');
                if (placeholder) {
                    const originalWords = app.currentSession.currentSentence.en.split(/\s+/).filter(w => w.trim() !== '');
                    const correctWord = originalWords.find(w => cleanString(w) === cleanString(userAnswer));
                    placeholder.textContent = isCorrect ? correctWord : '❌';
                    placeholder.style.color = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                }
            }
        }
        
        function useHint() {
            const effectiveMode = app.currentSession.currentModeForQuestion;
            if (effectiveMode !== 'Typing' && effectiveMode !== 'ListenType') return;
            const sentence = app.currentSession.currentSentence.en;
            const currentInput = DOMElements.game.typingInput.value;
            if (currentInput.length < sentence.length) {
                DOMElements.game.typingInput.value = sentence.substring(0, currentInput.length + 1);
            }
        }

        // --- 6. EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('settings-btn').onclick = () => { playSound('click'); vibrate(); showSettings(); };
            document.getElementById('stats-btn').onclick = () => { playSound('click'); vibrate(); showStats(); };
            document.getElementById('achievements-btn').onclick = () => { playSound('click'); vibrate(); showAchievements(); };
            DOMElements.genericScreen.backBtn.onclick = () => { playSound('click'); vibrate(); renderMainMenu(); };

            document.querySelector('#mode-selection-modal .modal-overlay').onclick = () => { playSound('click'); DOMElements.modals.modeSelection.classList.add('hidden'); };
            DOMElements.modals.modeSelectionButtons.addEventListener('click', e => {
                if (e.target.matches('[data-mode]')) startSession(e.target.dataset.mode);
            });
            
            document.getElementById('back-to-menu-btn').onclick = () => { playSound('click'); renderMainMenu(); };
            DOMElements.game.checkBtn.onclick = () => {
                if (app.currentSession.currentModeForQuestion === 'Typing' || app.currentSession.currentModeForQuestion === 'ListenType') {
                    checkAnswer(DOMElements.game.typingInput.value);
                }
            };
            DOMElements.game.nextBtn.onclick = () => { playSound('click'); app.currentSession.currentIndex++; renderQuestion(); };
            DOMElements.game.hintBtn.onclick = () => { playSound('click'); useHint(); };
            document.getElementById('replay-sound-btn').onclick = () => speak(app.currentSession?.currentSentence?.en);
            document.getElementById('summary-close-btn').onclick = () => { playSound('click'); DOMElements.modals.summary.classList.add('hidden'); renderMainMenu(); };
        }

        // --- 7. INITIALIZATION ---
        async function init() {
            if (app.isInitialized) return;
            app.isInitialized = true;
            loadData();
            document.body.dataset.theme = app.settings.theme;

            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => { app.ttsVoices = speechSynthesis.getVoices(); };
            }

            const levels = ['A1', 'A2', 'B1', 'B2'];
            const files = ['sentences1.json', 'sentences2.json', 'sentences3.json', 'sentences4.json'];
            for(let i=0; i < files.length; i++) {
                try {
                    document.getElementById('loading-status').textContent = `Loading ${levels[i]}...`;
                    const response = await fetch(files[i]);
                    if(!response.ok) throw new Error(`Failed to load`);
                    const data = await response.json();
                    const levelKey = levels[i];
                    app.sentences[levelKey] = {};
                    for (let j = 0; j < data.length; j += SUB_LEVEL_SIZE) {
                        const subLevelKey = (j / SUB_LEVEL_SIZE) + 1;
                        app.sentences[levelKey][subLevelKey] = data.slice(j, j + SUB_LEVEL_SIZE).map(s => ({...s, subLevel: `${subLevelKey}`}));
                    }
                } catch(e) { document.getElementById('loading-status').textContent = `Error. Please refresh.`; return; }
                document.getElementById('loading-progress').style.width = `${((i+1)/files.length) * 100}%`;
            }
            
            setupEventListeners();
            DOMElements.splashScreen.style.opacity = '0';
            setTimeout(() => { DOMElements.splashScreen.classList.add('hidden'); renderMainMenu(); }, 500);
        }
        
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>

